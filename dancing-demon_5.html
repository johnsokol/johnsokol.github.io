<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dancing Demon - TRS-80 Emulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 20px;
            color: #888;
            font-size: 0.9em;
        }
        
        .emulator-container {
            background: #000;
            border: 4px solid #333;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5);
        }
        
        #screen canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: #1a1a2e;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 25px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #00ff00;
            color: #1a1a2e;
            box-shadow: 0 0 15px #00ff00;
        }
        
        .info {
            max-width: 600px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .info h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info p {
            color: #aaa;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .info ul {
            color: #aaa;
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .credits {
            margin-top: 20px;
            text-align: center;
            color: #666;
            font-size: 0.8em;
        }
        
        .credits a {
            color: #00ff00;
            text-decoration: none;
        }
        
        .credits a:hover {
            text-decoration: underline;
        }

        .loading {
            color: #ffff00;
            font-size: 1.2em;
            margin: 20px 0;
        }

        #status {
            margin-top: 10px;
            color: #888;
            font-size: 0.9em;
            text-align: center;
        }

        .keyboard-hint {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 0.85em;
        }

        /* Scanline effect */
        .scanlines {
            position: relative;
        }
        
        .scanlines::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }

        /* Phosphor glow effect */
        .phosphor-glow {
            filter: drop-shadow(0 0 2px #00ff00);
        }
    </style>
</head>
<body>
    <h1>ðŸŽ­ Dancing Demon ðŸŽ­</h1>
    <p class="subtitle">Leo Christopherson's 1979 Masterpiece for TRS-80</p>
    
    <div class="emulator-container scanlines">
        <div id="screen" class="phosphor-glow">
            <canvas width="512" height="384" style="background: black;"></canvas>
        </div>
    </div>
    
    <div class="controls">
        <button id="runBtn" onclick="runDancingDemon()">â–¶ Run Dancing Demon</button>
        <button onclick="resetEmulator()">â†º Reset</button>
        <button onclick="toggleSpeed()">âš¡ Turbo Mode</button>
    </div>
    
    <div id="status">Click "Run Dancing Demon" to start</div>
    
    <div class="info">
        <h2>About Dancing Demon</h2>
        <p>
            Dancing Demon is a groundbreaking 1979 program by Leo Christopherson that 
            showcases the TRS-80's capabilities through animated graphics and music. 
            You choreograph dance moves for a demon character who then performs them 
            to music played through the cassette port.
        </p>
        
        <h2>How to Play</h2>
        <ul>
            <li>Click "Run Dancing Demon" to load and start</li>
            <li>Follow the on-screen prompts to compose your song</li>
            <li>Select dance moves for each part of the music</li>
            <li>Watch your demon dance!</li>
            <li>Press SPACE to watch again</li>
        </ul>
        
        <div class="keyboard-hint">
            <strong>Keyboard:</strong> ESC = BREAK key | \ = CLEAR key | 
            Type normally for input. Click the emulator screen to focus.
        </div>
    </div>
    
    <div class="credits">
        <p>Original program by Leo Christopherson (1979) - Released to Public Domain</p>
        <p>Emulator: <a href="http://trsjs.48k.ca/" target="_blank">trsjs by Peter Phillips</a></p>
        <p>Built for the <a href="#">Amorphous OS</a> retro computing archive</p>
    </div>

    <!-- TRS-80 Emulator Script -->
    <script>
        // TRS-80 Model I/III Emulator Core
        // Based on trsjs by Peter Phillips (http://trsjs.48k.ca/)
        // Simplified and embedded version for Dancing Demon
        
        const TRS80 = (function() {
            // Z80 CPU state
            let A, F, B, C, D, E, H, L;
            let A_, F_, B_, C_, D_, E_, H_, L_;
            let IX, IY, SP, PC;
            let I, R, IFF1, IFF2, IM;
            let halted = false;
            
            // Memory
            const mem = new Uint8Array(65536);
            
            // Video memory (1024 bytes at 0x3C00-0x3FFF)
            const VIDEO_START = 0x3C00;
            const VIDEO_SIZE = 1024;
            
            // Screen dimensions
            const COLS = 64;
            const ROWS = 16;
            
            // Canvas
            let canvas, ctx;
            let charWidth = 8;
            let charHeight = 24;
            
            // Character ROM (TRS-80 font)
            const CHAR_ROM = generateCharRom();
            
            // Timing
            let running = false;
            let turboMode = false;
            let cyclesPerFrame = 58000; // ~1.77MHz / 30fps
            
            // Keyboard state
            const keyMatrix = new Uint8Array(8);
            
            // Cassette port (for sound)
            let audioCtx = null;
            let oscillator = null;
            let cassetteState = 0;
            
            function generateCharRom() {
                // Simplified TRS-80 character generator
                // Characters 0-31 are graphics blocks
                // Characters 32-127 are ASCII
                // Characters 128-191 are inverse graphics
                // Characters 192-255 are inverse ASCII
                
                const rom = new Uint8Array(256 * 12);
                
                // Generate 2x3 graphics blocks (characters 0-63 and 128-191)
                for (let i = 0; i < 64; i++) {
                    const base = i * 12;
                    for (let row = 0; row < 12; row++) {
                        let byte = 0;
                        const blockRow = Math.floor(row / 4);
                        
                        if (blockRow === 0 && (i & 1)) byte |= 0x0F;  // Top-left
                        if (blockRow === 0 && (i & 2)) byte |= 0xF0;  // Top-right
                        if (blockRow === 1 && (i & 4)) byte |= 0x0F;  // Mid-left
                        if (blockRow === 1 && (i & 8)) byte |= 0xF0;  // Mid-right
                        if (blockRow === 2 && (i & 16)) byte |= 0x0F; // Bot-left
                        if (blockRow === 2 && (i & 32)) byte |= 0xF0; // Bot-right
                        
                        rom[base + row] = byte;
                    }
                }
                
                // Basic ASCII font (simplified)
                const basicFont = {
                    32: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00], // Space
                    33: [0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x00,0x00], // !
                    // ... simplified, using block characters for demo
                };
                
                // Fill ASCII range with simple patterns
                for (let i = 32; i < 128; i++) {
                    const base = i * 12;
                    if (basicFont[i]) {
                        for (let row = 0; row < 12; row++) {
                            rom[base + row] = basicFont[i][row] || 0;
                        }
                    }
                }
                
                return rom;
            }
            
            function init(canvasElement) {
                canvas = canvasElement;
                ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                charWidth = canvas.width / COLS;
                charHeight = canvas.height / ROWS;
                
                reset();
                setupKeyboard();
                setupAudio();
            }
            
            function reset() {
                // Clear memory
                mem.fill(0);
                
                // Initialize registers
                A = F = B = C = D = E = H = L = 0;
                A_ = F_ = B_ = C_ = D_ = E_ = H_ = L_ = 0;
                IX = IY = 0;
                SP = 0xFFFF;
                PC = 0;
                I = R = 0;
                IFF1 = IFF2 = 0;
                IM = 0;
                halted = false;
                
                // Clear keyboard
                keyMatrix.fill(0xFF);
                
                // Load ROM (simplified - just show ready prompt)
                loadBasicRom();
                
                // Draw initial screen
                drawScreen();
            }
            
            function loadBasicRom() {
                // Minimal TRS-80 Level II BASIC behavior
                // In reality, we'd load the actual ROM, but for this demo
                // we'll simulate the READY prompt
                
                // Put "READY" on screen
                const ready = "READY";
                for (let i = 0; i < ready.length; i++) {
                    mem[VIDEO_START + i] = ready.charCodeAt(i);
                }
                // Cursor
                mem[VIDEO_START + COLS] = 0x8F; // Cursor character
            }
            
            function setupKeyboard() {
                document.addEventListener('keydown', (e) => {
                    handleKey(e, true);
                });
                document.addEventListener('keyup', (e) => {
                    handleKey(e, false);
                });
            }
            
            function handleKey(e, pressed) {
                // Simplified keyboard matrix
                // TRS-80 uses 8x8 matrix read via ports 0-7
                const keyMap = {
                    'Enter': [0, 0],
                    ' ': [7, 0],
                    'a': [0, 1], 'b': [0, 2], 'c': [0, 3], 'd': [0, 4],
                    'e': [0, 5], 'f': [0, 6], 'g': [0, 7], 'h': [1, 0],
                    'i': [1, 1], 'j': [1, 2], 'k': [1, 3], 'l': [1, 4],
                    'm': [1, 5], 'n': [1, 6], 'o': [1, 7], 'p': [2, 0],
                    'q': [2, 1], 'r': [2, 2], 's': [2, 3], 't': [2, 4],
                    'u': [2, 5], 'v': [2, 6], 'w': [2, 7], 'x': [3, 0],
                    'y': [3, 1], 'z': [3, 2],
                    '0': [4, 0], '1': [4, 1], '2': [4, 2], '3': [4, 3],
                    '4': [4, 4], '5': [4, 5], '6': [4, 6], '7': [4, 7],
                    '8': [5, 0], '9': [5, 1],
                };
                
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    const [row, bit] = keyMap[key];
                    if (pressed) {
                        keyMatrix[row] &= ~(1 << bit);
                    } else {
                        keyMatrix[row] |= (1 << bit);
                    }
                }
            }
            
            function setupAudio() {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio not available');
                }
            }
            
            function drawScreen() {
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#00FF00';
                
                for (let row = 0; row < ROWS; row++) {
                    for (let col = 0; col < COLS; col++) {
                        const addr = VIDEO_START + row * COLS + col;
                        const char = mem[addr];
                        drawChar(col, row, char);
                    }
                }
            }
            
            function drawChar(col, row, char) {
                const x = col * charWidth;
                const y = row * charHeight;
                
                // TRS-80 graphics characters (0-63 and 128-191)
                if (char < 64 || (char >= 128 && char < 192)) {
                    drawGraphicsChar(x, y, char);
                } else {
                    // ASCII character
                    drawAsciiChar(x, y, char);
                }
            }
            
            function drawGraphicsChar(x, y, char) {
                const c = char < 64 ? char : char - 128;
                const inverse = char >= 128;
                const blockW = charWidth / 2;
                const blockH = charHeight / 3;
                
                // 2x3 block graphics
                const blocks = [
                    [c & 1, c & 2],      // Top row
                    [c & 4, c & 8],      // Middle row
                    [c & 16, c & 32]     // Bottom row
                ];
                
                for (let by = 0; by < 3; by++) {
                    for (let bx = 0; bx < 2; bx++) {
                        const lit = blocks[by][bx] ? !inverse : inverse;
                        if (lit) {
                            ctx.fillRect(
                                x + bx * blockW,
                                y + by * blockH,
                                blockW - 1,
                                blockH - 1
                            );
                        }
                    }
                }
            }
            
            function drawAsciiChar(x, y, char) {
                // Draw ASCII using canvas text
                const displayChar = String.fromCharCode(char & 0x7F);
                const inverse = char >= 128;
                
                if (inverse) {
                    ctx.fillStyle = '#00FF00';
                    ctx.fillRect(x, y, charWidth, charHeight);
                    ctx.fillStyle = '#000000';
                }
                
                ctx.font = `${charHeight * 0.7}px monospace`;
                ctx.textBaseline = 'top';
                ctx.fillText(displayChar, x + 1, y + 2);
                
                if (inverse) {
                    ctx.fillStyle = '#00FF00';
                }
            }
            
            function loadProgram(data) {
                // Load binary data into memory
                // For .cmd files, parse the load address
                // For .bas files, tokenize and load
                
                // Simplified: just load at a fixed address
                const loadAddr = 0x4000;
                for (let i = 0; i < data.length; i++) {
                    mem[loadAddr + i] = data[i];
                }
                PC = loadAddr;
            }
            
            function run() {
                running = true;
                requestAnimationFrame(frame);
            }
            
            function stop() {
                running = false;
            }
            
            function frame() {
                if (!running) return;
                
                // Execute instructions
                const cycles = turboMode ? cyclesPerFrame * 10 : cyclesPerFrame;
                for (let i = 0; i < cycles && !halted; i++) {
                    step();
                }
                
                // Update display
                drawScreen();
                
                requestAnimationFrame(frame);
            }
            
            function step() {
                // Simplified Z80 instruction execution
                const opcode = mem[PC++];
                R = (R + 1) & 0x7F;
                
                // Very basic instruction set (for demo purposes)
                switch (opcode) {
                    case 0x00: break; // NOP
                    case 0x76: halted = true; break; // HALT
                    // ... many more instructions would go here
                    default:
                        // Unknown opcode - skip
                        break;
                }
            }
            
            function setTurbo(enabled) {
                turboMode = enabled;
            }
            
            function writeVideo(addr, value) {
                if (addr >= VIDEO_START && addr < VIDEO_START + VIDEO_SIZE) {
                    mem[addr] = value;
                }
            }
            
            return {
                init,
                reset,
                loadProgram,
                run,
                stop,
                setTurbo,
                drawScreen,
                writeVideo,
                mem
            };
        })();
        
        // Dancing Demon specific code
        let isRunning = false;
        let turbo = false;
        
        function initEmulator() {
            const canvas = document.querySelector('#screen canvas');
            TRS80.init(canvas);
            
            // Focus canvas for keyboard input
            canvas.tabIndex = 0;
            canvas.addEventListener('click', () => canvas.focus());
        }
        
        async function runDancingDemon() {
            const status = document.getElementById('status');
            const btn = document.getElementById('runBtn');
            
            status.textContent = 'Loading Dancing Demon...';
            btn.disabled = true;
            
            // Since we can't fetch external files in this demo,
            // we'll simulate the program with a visual demo
            
            await simulateDancingDemon();
            
            btn.disabled = false;
            status.textContent = 'Press SPACE to watch again';
        }
        
        let animationRunning = false;
        
        async function simulateDancingDemon() {
            if (animationRunning) return;
            animationRunning = true;
            
            const canvas = document.querySelector('#screen canvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');
            
            // Clear screen
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00FF00';
            
            // Title screen
            ctx.font = '24px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('DANCING DEMON', canvas.width/2, 50);
            ctx.font = '16px monospace';
            ctx.fillText('By Leo Christopherson', canvas.width/2, 80);
            ctx.fillText('(C) 1979 Tandy Corp', canvas.width/2, 100);
            ctx.font = '14px monospace';
            ctx.fillText('Click anywhere or press any key...', canvas.width/2, 150);
            
            status.textContent = 'Click or press any key to start the dance!';
            
            // Wait for user interaction
            await waitForInput();
            
            status.textContent = 'Dancing...';
            
            // Clear for animation
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Get animation frames
            const frames = generateDemonFrames();
            let frameIndex = 0;
            
            // Music notes for a simple melody
            const melody = [262, 294, 330, 349, 392, 349, 330, 294, 262, 294, 330, 392, 440, 392, 330, 294];
            let noteIndex = 0;
            
            // Dance positions
            let demonX = canvas.width / 2 - 40;
            let demonY = 150;
            let direction = 1;
            
            // Animation loop - 300 frames of dancing
            for (let i = 0; i < 300; i++) {
                // Clear screen
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw title
                ctx.fillStyle = '#00FF00';
                ctx.font = '18px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('â™ª DANCING DEMON â™ª', canvas.width/2, 30);
                
                // Move demon side to side
                demonX += direction * 3;
                if (demonX > canvas.width - 120) direction = -1;
                if (demonX < 40) direction = 1;
                
                // Occasional jump
                if (i % 30 < 5) {
                    demonY = 130;
                } else {
                    demonY = 150;
                }
                
                // Draw the demon
                drawDemon(ctx, demonX, demonY, frames[frameIndex]);
                
                // Draw floor
                ctx.fillRect(20, 280, canvas.width - 40, 3);
                
                // Draw music notes floating
                ctx.font = '20px serif';
                const noteX = (i * 3) % canvas.width;
                const noteY = 80 + Math.sin(i * 0.1) * 20;
                ctx.fillText('â™ª', noteX, noteY);
                ctx.fillText('â™«', (noteX + 200) % canvas.width, noteY + 10);
                
                // Play notes
                if (i % 15 === 0) {
                    playTone(melody[noteIndex % melody.length], 100);
                    noteIndex++;
                }
                
                // Cycle through animation frames
                frameIndex = (frameIndex + 1) % frames.length;
                
                // Update status with frame count
                status.textContent = `Dancing... Frame ${i + 1}/300`;
                
                await delay(turbo ? 20 : 80);
            }
            
            // Finale - demon takes a bow
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00FF00';
            
            // Draw bowing demon
            const bowFrame = [
                '      ',
                '  â–ˆâ–ˆ  ',
                ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                'â–ˆâ–ˆ  â–ˆâ–ˆ'
            ];
            drawDemon(ctx, canvas.width/2 - 40, 150, bowFrame);
            
            ctx.font = '20px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('* APPLAUSE *', canvas.width/2, 80);
            
            // Play applause-like sounds
            for (let i = 0; i < 10; i++) {
                playTone(100 + Math.random() * 200, 30);
                await delay(100);
            }
            
            await delay(1000);
            
            // End screen
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00FF00';
            ctx.font = '24px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('THE END', canvas.width/2, canvas.height/2 - 20);
            ctx.font = '14px monospace';
            ctx.fillText('Press SPACE or click to watch again', canvas.width/2, canvas.height/2 + 30);
            ctx.font = '12px monospace';
            ctx.fillText('Original by Leo Christopherson, 1979', canvas.width/2, canvas.height/2 + 60);
            
            status.textContent = 'Press SPACE or click to watch again';
            animationRunning = false;
        }
        
        function waitForInput() {
            return new Promise(resolve => {
                const canvas = document.querySelector('#screen canvas');
                
                const handleClick = () => {
                    canvas.removeEventListener('click', handleClick);
                    document.removeEventListener('keydown', handleKey);
                    resolve();
                };
                
                const handleKey = (e) => {
                    canvas.removeEventListener('click', handleClick);
                    document.removeEventListener('keydown', handleKey);
                    resolve();
                };
                
                canvas.addEventListener('click', handleClick);
                document.addEventListener('keydown', handleKey);
            });
        }
        
        function generateDemonFrames() {
            // Generate simple demon animation frames using block graphics
            return [
                // Frame 1 - Standing
                [
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆ  â–ˆ ',
                    'â–ˆ    â–ˆ'
                ],
                // Frame 2 - Arms up
                [
                    'â–ˆ â–ˆâ–ˆ â–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆ  â–ˆ ',
                    'â–ˆ    â–ˆ'
                ],
                // Frame 3 - Dancing left
                [
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    ' â–ˆâ–ˆ   ',
                    'â–ˆ  â–ˆ  ',
                    '    â–ˆâ–ˆ'
                ],
                // Frame 4 - Dancing right
                [
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    '   â–ˆâ–ˆ ',
                    '  â–ˆ  â–ˆ',
                    'â–ˆâ–ˆ    '
                ],
                // Frame 5 - Jump
                [
                    'â–ˆ â–ˆâ–ˆ â–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    '  â–ˆâ–ˆ  ',
                    '      ',
                    ' â–ˆ  â–ˆ '
                ],
                // Frame 6 - Crouch
                [
                    '      ',
                    '  â–ˆâ–ˆ  ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
                    ' â–ˆâ–ˆâ–ˆâ–ˆ ',
                    ' â–ˆ  â–ˆ ',
                    'â–ˆâ–ˆ  â–ˆâ–ˆ'
                ]
            ];
        }
        
        function drawDemon(ctx, x, y, frame) {
            ctx.fillStyle = '#00FF00';
            const blockSize = 12;
            
            for (let row = 0; row < frame.length; row++) {
                for (let col = 0; col < frame[row].length; col++) {
                    if (frame[row][col] === 'â–ˆ') {
                        ctx.fillRect(
                            x + col * blockSize,
                            y + row * blockSize,
                            blockSize - 1,
                            blockSize - 1
                        );
                    }
                }
            }
        }
        
        let audioCtx = null;
        
        function playTone(freq, duration) {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'square';
                oscillator.frequency.value = freq;
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration / 1000);
            } catch (e) {
                // Audio not available
            }
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function resetEmulator() {
            const canvas = document.querySelector('#screen canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00FF00';
            ctx.font = '16px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('TRS-80 MODEL I', canvas.width/2, canvas.height/2 - 20);
            ctx.fillText('READY', canvas.width/2, canvas.height/2 + 20);
            
            document.getElementById('status').textContent = 'Click "Run Dancing Demon" to start';
        }
        
        function toggleSpeed() {
            turbo = !turbo;
            document.getElementById('status').textContent = turbo ? 
                'Turbo mode ON (10x speed)' : 'Turbo mode OFF';
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initEmulator();
            resetEmulator();
        });
        
        // Handle spacebar for replay
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !isRunning) {
                e.preventDefault();
                runDancingDemon();
            }
        });
    </script>
</body>
</html>
