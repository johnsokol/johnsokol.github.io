<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dancing Demon (1980) - TRS-80 Recreation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #c0c0ff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #c0c0ff;
            font-size: 2.5em;
            text-shadow: 0 0 10px #8080ff;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #8080c0;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: #1a1a3a;
            color: #c0c0ff;
            border: 2px solid #4040a0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #2a2a5a;
        }
        
        .tab.active {
            background: #4040a0;
            color: #fff;
            border-color: #8080ff;
        }
        
        .tab-content {
            display: none;
            background: #0a0a1a;
            border: 2px solid #4040a0;
            padding: 20px;
            border-radius: 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Stage */
        #stage-container {
            background: #000;
            border: 3px solid #c0c0ff;
            padding: 10px;
            margin: 20px 0;
            position: relative;
            min-height: 400px;
        }
        
        #stage-info {
            text-align: center;
            color: #c0c0ff;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        #stage {
            width: 100%;
            height: 400px;
            background: #000;
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #curtain {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 400px;
            background: repeating-linear-gradient(
                90deg,
                #8b0000 0px,
                #8b0000 20px,
                #600000 20px,
                #600000 40px
            );
            border: 3px solid #400000;
            transition: transform 1s ease-in-out;
            z-index: 10;
            display: none; /* Hidden by default */
            transform: scaleY(1);
            transform-origin: top;
        }
        
        #curtain.closed {
            display: block;
            transform: scaleY(1);
        }
        
        #curtain.opening {
            display: block;
            transform: scaleY(0);
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            background: #4040a0;
            color: #fff;
            border: 2px solid #8080ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover:not(:disabled) {
            background: #6060c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(128, 128, 255, 0.3);
        }
        
        button:disabled {
            background: #2a2a4a;
            color: #606080;
            cursor: not-allowed;
            border-color: #404060;
        }
        
        input[type="text"],
        textarea,
        input[type="number"] {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: #0a0a1a;
            color: #c0c0ff;
            border: 2px solid #4040a0;
            padding: 10px;
            width: 100%;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #c0c0ff;
            font-weight: bold;
        }
        
        /* Reference Tables */
        .reference-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .reference-table th,
        .reference-table td {
            border: 1px solid #4040a0;
            padding: 8px;
            text-align: left;
        }
        
        .reference-table th {
            background: #2a2a5a;
            color: #fff;
        }
        
        .reference-table tr:nth-child(even) {
            background: #0a0a1a;
        }
        
        .reference-table tr:hover {
            background: #1a1a3a;
        }
        
        .key-display {
            display: inline-block;
            background: #4040a0;
            color: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        kbd {
            display: inline-block;
            padding: 3px 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #2a2a5a;
            color: #ffff00;
            border: 2px solid #4040a0;
            border-radius: 3px;
            box-shadow: 0 2px 0 #1a1a3a;
        }
        
        /* Examples */
        .example-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .example-button {
            padding: 10px;
            background: #1a1a3a;
            border: 2px solid #4040a0;
            color: #c0c0ff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .example-button:hover {
            background: #2a2a5a;
            border-color: #8080ff;
        }
        
        /* Info boxes */
        .info-box {
            background: #1a1a3a;
            border-left: 4px solid #4040a0;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning-box {
            background: #3a1a1a;
            border-left: 4px solid #a04040;
            padding: 15px;
            margin: 15px 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ DANCING DEMON üé≠</h1>
        <div class="subtitle">
            TRS-80 Classic (1980) - Created by Leo Christopherson<br>
            Web Recreation - Programming & Choreography Interface
        </div>
        <div id="visitor-info" style="text-align: center; color: #8080c0; font-size: 0.9em; margin: 10px 0;">
            Loading visitor count...
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="performance">Performance</div>
            <div class="tab" data-tab="music">Compose Music</div>
            <div class="tab" data-tab="dance">Choreograph Dance</div>
            <div class="tab" data-tab="examples">Examples</div>
            <div class="tab" data-tab="reference">Reference</div>
            <div class="tab" data-tab="about">About</div>
        </div>
        
        <!-- Performance Tab -->
        <div class="tab-content active" data-content="performance">
            <div id="stage-info">Belvedere Theater, Oskowatcha, Washington</div>
            
            <div id="stage-container">
                <div id="curtain"></div>
                <canvas id="stage" width="640" height="400"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-show">üé¨ Start Show</button>
                <button id="stop-show">‚èπÔ∏è Stop Show</button>
                <button id="toggle-curtain">üé≠ Toggle Curtain</button>
            </div>
            
            <div class="input-group">
                <label>Speed Factor (1=fastest, 100=normal, 255=slowest):</label>
                <input type="number" id="speed-factor" min="1" max="255" value="100">
            </div>
            
            <div class="input-group">
                <label>Number of Performances:</label>
                <input type="number" id="num-performances" min="1" max="10" value="1">
            </div>
            
            <div class="info-box">
                <strong>Instructions:</strong><br>
                1. Compose your music in the "Compose Music" tab using GWBASIC PLAY notation<br>
                2. Choreograph your dance in the "Choreograph Dance" tab<br>
                3. Click "Start Show" to watch the Dancing Demon perform!<br>
                4. Or try one of the pre-programmed examples!<br>
                <br>
                üé≠ <strong>Theatrical Features:</strong><br>
                ‚Ä¢ Curtain automatically opens at show start<br>
                ‚Ä¢ Curtain closes slowly at show end<br>
                ‚Ä¢ Dance preview opens curtain and closes when done<br>
                ‚Ä¢ Tap sounds play during steps and stomps<br>
                <br>
                üí° <strong>Quick Tip:</strong> Press <kbd>SPACE</kbd> to start/stop, <kbd>ESC</kbd> to stop, <kbd>C</kbd> to toggle curtain
            </div>
        </div>
        
        <!-- Music Tab -->
        <div class="tab-content" data-content="music">
            <h2>Musical Score Composer</h2>
            
            <div class="info-box">
                Enter music using extended GWBASIC PLAY notation with chord support!<br>
                <strong>Examples:</strong><br>
                ‚Ä¢ Simple notes: <code>T120 O4 L4 C D E F G</code><br>
                ‚Ä¢ With chords: <code>T120 O4 L4 [C,E,G]4 [D,F,A]4 [E,G,B]4</code><br>
                ‚Ä¢ Multi-octave: <code>[O2C,O4C,E,G]2</code> (bass + chord)<br>
                The music will loop until the dance routine is complete.
            </div>
            
            <div class="input-group">
                <label>Musical Score (GWBASIC PLAY notation):</label>
                <textarea id="music-input" placeholder="Example: T140 O4 L8 C D E F G A B O5 C [C,E,G]2"></textarea>
                <div style="color: #8080c0; font-size: 0.9em; margin-top: 5px;">
                    Characters: <span id="music-length">0</span>/1000
                </div>
            </div>
            
            <div class="controls">
                <button id="test-music">‚ñ∂Ô∏è Test Music</button>
                <button id="stop-music">‚èπÔ∏è Stop Music</button>
                <button id="clear-music">üóëÔ∏è Clear</button>
            </div>
            
            <h3>GWBASIC PLAY Command Reference</h3>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Command</th>
                        <th>Description</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td class="key-display">T</td><td>Set tempo (BPM)</td><td>T120</td></tr>
                    <tr><td class="key-display">O</td><td>Set octave (0-6)</td><td>O4</td></tr>
                    <tr><td class="key-display">L</td><td>Set default note length</td><td>L4 (quarter note)</td></tr>
                    <tr><td class="key-display">A-G</td><td>Play note</td><td>C D E F G A B</td></tr>
                    <tr><td class="key-display">#</td><td>Sharp</td><td>C# F# G#</td></tr>
                    <tr><td class="key-display">b</td><td>Flat</td><td>Db Eb Bb</td></tr>
                    <tr><td class="key-display">P</td><td>Pause/Rest</td><td>P4 (quarter rest)</td></tr>
                    <tr><td class="key-display">n</td><td>Note duration</td><td>C4 (quarter), C2 (half), C1 (whole)</td></tr>
                    <tr><td class="key-display">[notes]</td><td>Chord (NEW!)</td><td>[C,E,G]4</td></tr>
                    <tr><td class="key-display">[O#,notes]</td><td>Multi-octave chord</td><td>[O2C,O4E,G]2</td></tr>
                </tbody>
            </table>
            
            <h3>Chord Examples</h3>
            <div class="info-box">
                <strong>C Major:</strong> <code>[C,E,G]</code><br>
                <strong>G7:</strong> <code>[G,B,D,F]</code><br>
                <strong>Piano style (bass + chord):</strong> <code>[O2C,O4C,E,G]</code><br>
                <strong>Sequence:</strong> <code>T120 O4 L4 [C,E,G]4 [F,A,O5C]4 [G,B,O5D]4 [C,E,O5C]2</code>
            </div>
        </div>
        
        <!-- Dance Tab -->
        <div class="tab-content" data-content="dance">
            <h2>Dance Routine Choreographer</h2>
            
            <div class="info-box">
                Create a dance routine using letters A-R. Each letter represents a different move.
                The routine will repeat until the music finishes.
            </div>
            
            <div class="input-group">
                <label>Dance Routine (up to 255 steps):</label>
                <textarea id="dance-input" placeholder="Example: AAEDBCFEGHAAED"></textarea>
                <div style="color: #8080c0; font-size: 0.9em; margin-top: 5px;">
                    Characters: <span id="dance-length">0</span>/255
                </div>
            </div>
            
            <div class="controls">
                <button id="test-dance">‚ñ∂Ô∏è Preview Dance</button>
                <button id="stop-dance">‚èπÔ∏è Stop Preview</button>
                <button id="clear-dance">üóëÔ∏è Clear</button>
            </div>
            
            <h3>Dance Move Reference</h3>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Move</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td class="key-display">A</td><td>STEP #1</td><td>2 counts</td></tr>
                    <tr><td class="key-display">B</td><td>STEP #2</td><td>2 counts</td></tr>
                    <tr><td class="key-display">C</td><td>STEP (L)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">D</td><td>STEP (R)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">E</td><td>SQUAT #1 (L)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">F</td><td>SQUAT #1 (R)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">G</td><td>STOMP #1 (L)</td><td>4 counts</td></tr>
                    <tr><td class="key-display">H</td><td>STOMP #1 (R)</td><td>4 counts</td></tr>
                    <tr><td class="key-display">I</td><td>WAVE #1 (L)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">J</td><td>WAVE #1 (R)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">K</td><td>SWING</td><td>1 count</td></tr>
                    <tr><td class="key-display">L</td><td>STOMP #2 (L)</td><td>1 count</td></tr>
                    <tr><td class="key-display">M</td><td>STOMP #2 (R)</td><td>1 count</td></tr>
                    <tr><td class="key-display">N</td><td>STOMP #3 (L)</td><td>4 counts</td></tr>
                    <tr><td class="key-display">O</td><td>SQUAT #2 (L)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">P</td><td>SQUAT #2 (R)</td><td>2 counts</td></tr>
                    <tr><td class="key-display">Q</td><td>SPIN JUMP</td><td>2 counts</td></tr>
                    <tr><td class="key-display">R</td><td>SPIN JUMP</td><td>2 counts</td></tr>
                    <tr><td class="key-display">S</td><td>üåÄ SPIN LEFT</td><td>3 counts</td></tr>
                    <tr><td class="key-display">T</td><td>üåÄ SPIN RIGHT</td><td>3 counts</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Examples Tab -->
        <div class="tab-content" data-content="examples">
            <h2>Pre-Programmed Routines</h2>
            
            <div class="info-box">
                The original Dancing Demon came with two classic routines. Click to load them!
            </div>
            
            <h3>Classic Routines</h3>
            <div class="example-list">
                <div class="example-button" data-example="aint-she-sweet">
                    üéµ Ain't She Sweet
                </div>
                <div class="example-button" data-example="encore">
                    üé≠ Encore Performance
                </div>
            </div>
            
            <h3>Custom Examples</h3>
            <div class="example-list">
                <div class="example-button" data-example="simple-demo">
                    üë∂ Simple Demo
                </div>
                <div class="example-button" data-example="jazz-hands">
                    üé∫ Jazz Hands
                </div>
                <div class="example-button" data-example="stomp-fest">
                    ü¶∂ Stomp Fest
                </div>
                <div class="example-button" data-example="wave-dance">
                    üëã Wave Dance
                </div>
            </div>
            
            <div class="controls">
                <button id="save-routine">üíæ Save Current Routine</button>
                <button id="load-routine">üìÅ Load Saved Routine</button>
                <button id="export-routine">üì§ Export to Text</button>
            </div>
            
            <div id="export-output" style="display: none;">
                <div class="input-group">
                    <label>Exported Routine (copy this text):</label>
                    <textarea id="export-text" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Reference Tab -->
        <div class="tab-content" data-content="reference">
            <h2>Dancing Demon Reference Guide</h2>
            
            <div class="info-box">
                <strong>About the Original Game:</strong><br>
                Dancing Demon was created by Leo Christopherson in 1979-1980 and published by Radio Shack
                for the TRS-80 Model I computer. It cost $9.95 and came on cassette tape. The game was
                considered a masterpiece of early computer graphics and sound synthesis.
            </div>
            
            <h3>How to Create Your Show</h3>
            <ol style="line-height: 1.8; margin: 20px; color: #c0c0ff;">
                <li><strong>Compose Music:</strong> Use the Music tab to create a melody using GWBASIC PLAY notation (e.g., <code>T120 O4 L4 C D E F G</code> or with chords <code>[C,E,G]4</code>)</li>
                <li><strong>Choreograph Dance:</strong> Use the Dance tab to string together dance moves using letters A-T</li>
                <li><strong>Set Performance Options:</strong> Adjust speed and number of performances</li>
                <li><strong>Watch the Show:</strong> Return to the Performance tab and click "Start Show" - curtain opens automatically!</li>
                <li><strong>Save Your Work:</strong> Use the Examples tab to save your creation for later</li>
            </ol>
            
            <h3>Tips for Great Performances</h3>
            <div class="warning-box">
                <strong>Pro Tips:</strong>
                <ul style="margin: 10px 0 10px 20px;">
                    <li>Use GWBASIC chord notation for richer harmonies: <code>[C,E,G]4</code></li>
                    <li>Combine bass and melody: <code>[O2C,O4C,E,G]</code> for piano-style accompaniment</li>
                    <li>Match the rhythm of your music to the timing of dance moves</li>
                    <li>Use shorter moves (like SWING - K) for fast songs</li>
                    <li>Use longer moves (like STOMP - G/H) for slower, dramatic moments</li>
                    <li>New spin moves! Use S for spin left, T for spin right</li>
                    <li>Tap sounds play automatically on steps and stomps</li>
                    <li>Alternate between left and right moves for realistic choreography</li>
                    <li>The dance routine will loop, so make it interesting!</li>
                    <li>Start simple - create a 4-bar melody first, then expand</li>
                    <li>The curtain automatically opens/closes for a theatrical presentation</li>
                </ul>
            </div>
            
            <h3>Technical Information</h3>
            <div class="info-box">
                <strong>Specifications:</strong><br>
                ‚Ä¢ Maximum Music Length: 1000 characters (GWBASIC PLAY notation)<br>
                ‚Ä¢ Maximum Dance Length: 255 steps<br>
                ‚Ä¢ Musical Notation: Extended GWBASIC PLAY with chord support<br>
                ‚Ä¢ Number of Dance Moves: 20 unique moves (includes spins!)<br>
                ‚Ä¢ Move Duration: 1-4 counts each<br>
                ‚Ä¢ Sound Effects: Tap dance clicks on stomps and steps<br>
                ‚Ä¢ Curtain Choreography: Automatic opening/closing<br>
                ‚Ä¢ Original Platform: TRS-80 Model I (16K RAM)<br>
                ‚Ä¢ Original Price: $9.95 (1980)<br>
                ‚Ä¢ Creator: Leo Christopherson<br>
                ‚Ä¢ Status: Public Domain<br>
                ‚Ä¢ Modern Enhancement: Chord-capable GWBASIC PLAY syntax
            </div>
        </div>
        
        <!-- About Tab -->
        <div class="tab-content" data-content="about">
            <h2>About Dancing Demon</h2>
            
            <div class="info-box">
                <strong>The Story of Dancing Demon</strong><br><br>
                In 1979-1980, programmer Leo Christopherson created what would become one of the most
                beloved and innovative programs for the TRS-80 computer. Dancing Demon wasn't just a game -
                it was an early music composition and animation tool that pushed the limits of what home
                computers could do.
                <br><br>
                The program featured a charming character (the "Dancing Demon") who would perform elaborate
                dance routines synchronized to user-composed music. This was revolutionary for its time,
                combining graphics, sound, and user creativity in ways that were rarely seen.
                <br><br>
                The original manual tells the whimsical story of Joe Hornbuckle, a manager who discovers
                the Dancing Demon performing at a festival in Hades and brings him to stardom, only to
                eventually abandon him. The player then becomes the demon's new manager, responsible for
                creating new performances.
            </div>
            
            <div class="info-box">
                <strong>Technical Innovation</strong><br><br>
                Dancing Demon used cutting-edge techniques for its era:
                <ul style="margin: 10px 0 10px 20px;">
                    <li>Machine language routines embedded in BASIC for smooth animation</li>
                    <li>Self-modifying code that overwrote itself in memory (copy protection)</li>
                    <li>Synchronized audio and visual output</li>
                    <li>User-friendly creation tools decades before modern music software</li>
                </ul>
                <br>
                The program was so impressive that it was later ported to other systems including the ZX81,
                and enhanced versions were created by enthusiasts like George Phillips who doubled the
                sprite resolution in 2009.
            </div>
            
            <div class="info-box">
                <strong>This Recreation</strong><br><br>
                This web-based recreation honors the original Dancing Demon while taking advantage of
                modern web technologies. Features include:
                <ul style="margin: 10px 0 10px 20px;">
                    <li>Extended GWBASIC PLAY notation with full chord support</li>
                    <li>All 18 original dance moves plus 2 new spin moves (20 total!)</li>
                    <li>Tap dance sound effects synchronized to steps and stomps</li>
                    <li>Enhanced graphics while maintaining the retro aesthetic</li>
                    <li>Automatic curtain choreography (opens/closes with performances)</li>
                    <li>Dance preview mode with curtain presentation</li>
                    <li>Save/load functionality for your creations</li>
                    <li>Firebase visitor tracking and analytics</li>
                    <li>No cassette tape loading required!</li>
                </ul>
                <br>
                The original Dancing Demon was released into the public domain, making recreations like
                this possible. This project is a tribute to Leo Christopherson's innovative work and the
                creative spirit of early home computing.
                <br><br>
                üî• <strong>Powered by Firebase:</strong> This site uses the Vector Kong Firebase database
                to track visitors and maintain a guest log. Your visit helps us understand how many people
                are enjoying this piece of computing history!
                <br><br>
                üéµ <strong>Musical Enhancement:</strong> The extended GWBASIC PLAY syntax allows for complex
                chord progressions, multi-octave arrangements, and professional-quality compositions far
                beyond what the original TRS-80 could do!
            </div>
            
            <div class="warning-box">
                <strong>Credits</strong><br>
                Original Program: Leo Christopherson (1979-1980)<br>
                Original Publisher: Radio Shack / Tandy Corporation<br>
                Web Recreation: 2025<br>
                <br>
                Special thanks to:<br>
                ‚Ä¢ George Phillips for the Doubled Dancing Demon enhanced version<br>
                ‚Ä¢ The TRS-80 preservation community<br>
                ‚Ä¢ Internet Archive for preserving the original manual<br>
                ‚Ä¢ All the retro computing enthusiasts keeping this history alive
            </div>
            
            <div class="info-box">
                <strong>‚å®Ô∏è Keyboard Shortcuts</strong><br><br>
                <strong>SPACE</strong> - Start/Stop Show (when not typing)<br>
                <strong>ESC</strong> - Stop Show<br>
                <strong>C</strong> - Toggle Curtain (when not typing)<br>
            </div>
            
            <h3>üë• Recent Visitors</h3>
            <div id="visitor-log" style="
                max-height: 300px; 
                overflow-y: auto; 
                background: #0a0a1a; 
                border: 2px solid #4040a0; 
                padding: 15px;
                margin: 15px 0;
            ">
                <div style="color: #8080c0; text-align: center;">Loading visitor log...</div>
            </div>
            <button onclick="app.refreshVisitorLog()" style="margin-top: 10px;">
                üîÑ Refresh Visitor Log
            </button>
        </div>
    </div>
    
    <script type="module">
        // ===========================
        // Firebase Configuration
        // ===========================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD9GvYoq4j3XginipLtbWOvaW1dEFdOfIs",
            authDomain: "vector-kong-leaderboard.firebaseapp.com",
            projectId: "vector-kong-leaderboard",
            storageBucket: "vector-kong-leaderboard.firebasestorage.app",
            messagingSenderId: "899598987750",
            appId: "1:899598987750:web:79608ee3198585d15aa627",
            measurementId: "G-7V4FZD1HSG"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        
        // ===========================
        // GWBASIC Music Player Engine (Extended with Chord Support)
        // ===========================
        
        class MusicPlayer {
            constructor() {
                this.audioContext = null;
                this.currentNote = null;
                this.isPlaying = false;
                this.tempo = 120; // BPM
                this.currentOctave = 4;
                this.defaultLength = 4; // quarter note
                this.volume = 0.3;
                
                // Note frequencies
                this.noteFrequencies = {
                    'C': 261.63, 'C#': 277.18, 'Db': 277.18,
                    'D': 293.66, 'D#': 311.13, 'Eb': 311.13,
                    'E': 329.63,
                    'F': 349.23, 'F#': 369.99, 'Gb': 369.99,
                    'G': 392.00, 'G#': 415.30, 'Ab': 415.30,
                    'A': 440.00, 'A#': 466.16, 'Bb': 466.16,
                    'B': 493.88
                };
            }
            
            initAudio() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.audioContext;
            }
            
            getFrequency(note, octave) {
                const baseFreq = this.noteFrequencies[note];
                if (!baseFreq) return 0;
                const octaveMultiplier = Math.pow(2, octave - 4);
                return baseFreq * octaveMultiplier;
            }
            
            playNote(frequency, duration, callback) {
                const ctx = this.initAudio();
                
                if (frequency === 0) {
                    setTimeout(callback, duration);
                    return;
                }
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);
                
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(this.volume, ctx.currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(this.volume, ctx.currentTime + duration / 1000 - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + duration / 1000);
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration / 1000);
                
                setTimeout(callback, duration);
            }
            
            playChord(frequencies, duration, callback) {
                const ctx = this.initAudio();
                const oscillators = [];
                const gainNode = ctx.createGain();
                
                frequencies.forEach(freq => {
                    if (freq > 0) {
                        const osc = ctx.createOscillator();
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(freq, ctx.currentTime);
                        osc.connect(gainNode);
                        oscillators.push(osc);
                    }
                });
                
                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(this.volume / Math.sqrt(oscillators.length), ctx.currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(this.volume / Math.sqrt(oscillators.length), ctx.currentTime + duration / 1000 - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + duration / 1000);
                
                gainNode.connect(ctx.destination);
                
                oscillators.forEach(osc => {
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + duration / 1000);
                });
                
                setTimeout(callback, duration);
            }
            
            parsePlayString(playString) {
                const commands = [];
                let i = 0;
                
                while (i < playString.length) {
                    const char = playString[i].toUpperCase();
                    
                    // Handle chord notation [note,note,note]
                    if (char === '[') {
                        const endBracket = playString.indexOf(']', i);
                        if (endBracket === -1) {
                            i++;
                            continue;
                        }
                        
                        const chordContent = playString.substring(i + 1, endBracket);
                        const notes = chordContent.split(',');
                        
                        // Parse duration after bracket
                        let duration = this.defaultLength;
                        let nextIdx = endBracket + 1;
                        if (nextIdx < playString.length && /\d/.test(playString[nextIdx])) {
                            let numStr = '';
                            while (nextIdx < playString.length && /\d/.test(playString[nextIdx])) {
                                numStr += playString[nextIdx];
                                nextIdx++;
                            }
                            duration = parseInt(numStr);
                        }
                        
                        let tempOctave = this.currentOctave;
                        const frequencies = [];
                        
                        notes.forEach(noteStr => {
                            noteStr = noteStr.trim();
                            
                            // Check for octave change
                            if (noteStr.startsWith('O')) {
                                tempOctave = parseInt(noteStr.substring(1));
                                return;
                            }
                            
                            // Parse note
                            let noteName = noteStr[0];
                            let idx = 1;
                            
                            if (idx < noteStr.length && (noteStr[idx] === '#' || noteStr[idx] === 'b')) {
                                noteName += noteStr[idx];
                                idx++;
                            }
                            
                            const freq = this.getFrequency(noteName, tempOctave);
                            if (freq) frequencies.push(freq);
                        });
                        
                        commands.push({ type: 'chord', frequencies, duration });
                        i = nextIdx;
                        continue;
                    }
                    
                    // Tempo
                    if (char === 'T') {
                        let numStr = '';
                        i++;
                        while (i < playString.length && /\d/.test(playString[i])) {
                            numStr += playString[i];
                            i++;
                        }
                        this.tempo = parseInt(numStr) || 120;
                        continue;
                    }
                    
                    // Octave
                    if (char === 'O') {
                        let numStr = '';
                        i++;
                        while (i < playString.length && /\d/.test(playString[i])) {
                            numStr += playString[i];
                            i++;
                        }
                        this.currentOctave = parseInt(numStr) || 4;
                        continue;
                    }
                    
                    // Default length
                    if (char === 'L') {
                        let numStr = '';
                        i++;
                        while (i < playString.length && /\d/.test(playString[i])) {
                            numStr += playString[i];
                            i++;
                        }
                        this.defaultLength = parseInt(numStr) || 4;
                        continue;
                    }
                    
                    // Pause/Rest
                    if (char === 'P') {
                        let numStr = '';
                        i++;
                        while (i < playString.length && /\d/.test(playString[i])) {
                            numStr += playString[i];
                            i++;
                        }
                        const duration = parseInt(numStr) || this.defaultLength;
                        commands.push({ type: 'rest', duration });
                        continue;
                    }
                    
                    // Notes A-G
                    if ('ABCDEFG'.includes(char)) {
                        let noteName = char;
                        i++;
                        
                        // Check for sharp or flat
                        if (i < playString.length && (playString[i] === '#' || playString[i].toLowerCase() === 'b')) {
                            noteName += playString[i];
                            i++;
                        }
                        
                        // Check for duration
                        let duration = this.defaultLength;
                        if (i < playString.length && /\d/.test(playString[i])) {
                            let numStr = '';
                            while (i < playString.length && /\d/.test(playString[i])) {
                                numStr += playString[i];
                                i++;
                            }
                            duration = parseInt(numStr);
                        }
                        
                        const freq = this.getFrequency(noteName, this.currentOctave);
                        commands.push({ type: 'note', frequency: freq, duration });
                        continue;
                    }
                    
                    i++;
                }
                
                return commands;
            }
            
            playSequence(playString, callback) {
                this.isPlaying = true;
                const commands = this.parsePlayString(playString);
                let commandIndex = 0;
                
                const playNext = () => {
                    if (!this.isPlaying || commandIndex >= commands.length) {
                        this.isPlaying = false;
                        if (callback) callback();
                        return;
                    }
                    
                    const cmd = commands[commandIndex];
                    commandIndex++;
                    
                    const noteDuration = (60000 / this.tempo) * (4 / cmd.duration);
                    
                    if (cmd.type === 'rest') {
                        setTimeout(playNext, noteDuration);
                    } else if (cmd.type === 'chord') {
                        this.playChord(cmd.frequencies, noteDuration, playNext);
                    } else if (cmd.type === 'note') {
                        this.playNote(cmd.frequency, noteDuration, playNext);
                    } else {
                        playNext();
                    }
                };
                
                playNext();
            }
            
            stop() {
                this.isPlaying = false;
            }
        }
        
        // ===========================
        // Tap Dance Sound Effects
        // ===========================
        
        class TapSoundPlayer {
            constructor() {
                this.audioContext = null;
            }
            
            initAudio() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.audioContext;
            }
            
            playTap() {
                const ctx = this.initAudio();
                
                // Create a short percussive click
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, ctx.currentTime);
                
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(200, ctx.currentTime);
                
                gainNode.gain.setValueAtTime(0.4, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.05);
            }
        }
        
        // ===========================
        // Dance Animation Engine
        // ===========================
        
        class DanceAnimator {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.currentFrame = 0;
                this.isAnimating = false;
                this.animationId = null;
                this.tapPlayer = new TapSoundPlayer();
                
                // Dance move definitions with frame sequences and durations
                this.danceMoves = {
                    'A': { frames: [0, 1, 0, 1], duration: 2, name: 'STEP #1', hasTap: true },
                    'B': { frames: [0, 2, 0, 2], duration: 2, name: 'STEP #2', hasTap: true },
                    'C': { frames: [0, 3, 0, 3], duration: 2, name: 'STEP (L)', hasTap: true },
                    'D': { frames: [0, 4, 0, 4], duration: 2, name: 'STEP (R)', hasTap: true },
                    'E': { frames: [5, 5], duration: 2, name: 'SQUAT #1 (L)', hasTap: false },
                    'F': { frames: [6, 6], duration: 2, name: 'SQUAT #1 (R)', hasTap: false },
                    'G': { frames: [7, 7, 7, 7], duration: 4, name: 'STOMP #1 (L)', hasTap: true },
                    'H': { frames: [8, 8, 8, 8], duration: 4, name: 'STOMP #1 (R)', hasTap: true },
                    'I': { frames: [1, 1], duration: 2, name: 'WAVE #1 (L)', hasTap: false },
                    'J': { frames: [4, 4], duration: 2, name: 'WAVE #1 (R)', hasTap: false },
                    'K': { frames: [2], duration: 1, name: 'SWING', hasTap: false },
                    'L': { frames: [7], duration: 1, name: 'STOMP #2 (L)', hasTap: true },
                    'M': { frames: [8], duration: 1, name: 'STOMP #2 (R)', hasTap: true },
                    'N': { frames: [7, 7, 7, 7], duration: 4, name: 'STOMP #3 (L)', hasTap: true },
                    'O': { frames: [5, 5], duration: 2, name: 'SQUAT #2 (L)', hasTap: false },
                    'P': { frames: [6, 6], duration: 2, name: 'SQUAT #2 (R)', hasTap: false },
                    'Q': { frames: [2, 3, 4, 1], duration: 2, name: 'SPIN JUMP', hasTap: true },
                    'R': { frames: [1, 4, 3, 2], duration: 2, name: 'SPIN JUMP', hasTap: true },
                    'S': { frames: [0, 2, 3, 4, 1, 0], duration: 3, name: 'SPIN LEFT', hasTap: false }, // New spin left
                    'T': { frames: [0, 1, 4, 3, 2, 0], duration: 3, name: 'SPIN RIGHT', hasTap: false }  // New spin right
                };
                
                this.spriteFrames = this.createSpriteFrames();
            }
            
            createSpriteFrames() {
                // Create simplified sprite frames (we'll draw them procedurally)
                // Frame 0: Neutral standing
                // Frame 1: Arms up
                // Frame 2: Left leg up
                // Frame 3: Wide stance
                // Frame 4: Right leg up
                // Frame 5: Left squat
                // Frame 6: Right squat
                // Frame 7: Left stomp
                // Frame 8: Right stomp
                return 9; // Number of frames
            }
            
            drawDemon(frameIndex, x, y, scale = 1.5) {
                const ctx = this.ctx;
                const pixelSize = 4 * scale;
                const color = '#c0c0ff';
                
                // Clear area
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw stage background with gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#0a0a1a');
                gradient.addColorStop(1, '#000');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw stage floor
                ctx.fillStyle = '#4040a0';
                ctx.fillRect(0, this.canvas.height - 20, this.canvas.width, 20);
                
                // Stage floor highlights
                ctx.fillStyle = '#6060c0';
                ctx.fillRect(0, this.canvas.height - 20, this.canvas.width, 2);
                
                // Spotlights on floor
                const spotlightGradient = ctx.createRadialGradient(
                    this.canvas.width / 2, this.canvas.height - 10,
                    10,
                    this.canvas.width / 2, this.canvas.height - 10,
                    150
                );
                spotlightGradient.addColorStop(0, 'rgba(192, 192, 255, 0.3)');
                spotlightGradient.addColorStop(1, 'rgba(192, 192, 255, 0)');
                ctx.fillStyle = spotlightGradient;
                ctx.fillRect(0, this.canvas.height - 100, this.canvas.width, 100);
                
                // Center the demon
                const centerX = this.canvas.width / 2;
                const baseY = this.canvas.height - 80;
                
                // Add glow effect around demon
                ctx.shadowColor = 'rgba(192, 192, 255, 0.5)';
                ctx.shadowBlur = 20;
                
                ctx.fillStyle = color;
                
                // Simplified sprite drawing based on frame
                // This is a placeholder - in a full implementation, we'd draw pixel-perfect sprites
                switch(frameIndex) {
                    case 0: // Neutral
                        this.drawNeutralDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 1: // Arms up
                        this.drawArmsUpDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 2: // Left leg up
                        this.drawLeftLegUpDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 3: // Wide stance
                        this.drawWideStanceDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 4: // Right leg up
                        this.drawRightLegUpDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 5: // Left squat
                        this.drawLeftSquatDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 6: // Right squat
                        this.drawRightSquatDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 7: // Left stomp
                        this.drawLeftStompDemon(ctx, centerX, baseY, pixelSize);
                        break;
                    case 8: // Right stomp
                        this.drawRightStompDemon(ctx, centerX, baseY, pixelSize);
                        break;
                }
                
                // Clear shadow effect
                ctx.shadowBlur = 0;
            }
            
            // Accurate demon drawing methods based on TRS-80 screenshots
            drawNeutralDemon(ctx, x, y, p) {
                // Head - wider top
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p); // Top of head
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p); // Upper head
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p); // Main head
                
                // Horns - small bumps on top
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p); // Left horn
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);  // Right horn
                
                // Eyes - square white with black center
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p); // Left eye white
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p); // Right eye white
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p); // Left eye pupil
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p); // Right eye pupil
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders/upper body
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso - narrow
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms - angled out
                ctx.fillRect(x - 9*p, y - 14*p, 3*p, 2*p);  // Left upper arm
                ctx.fillRect(x - 10*p, y - 12*p, 3*p, 6*p); // Left lower arm
                ctx.fillRect(x + 6*p, y - 14*p, 3*p, 2*p);  // Right upper arm
                ctx.fillRect(x + 7*p, y - 12*p, 3*p, 6*p);  // Right lower arm
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // Legs
                ctx.fillRect(x - 5*p, y - 2*p, 3*p, 10*p);  // Left leg
                ctx.fillRect(x + 2*p, y - 2*p, 3*p, 10*p);  // Right leg
            }
            
            drawArmsUpDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms RAISED UP HIGH!
                ctx.fillRect(x - 10*p, y - 24*p, 3*p, 8*p); // Left arm up
                ctx.fillRect(x + 7*p, y - 24*p, 3*p, 8*p);  // Right arm up
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // Legs
                ctx.fillRect(x - 5*p, y - 2*p, 3*p, 10*p);
                ctx.fillRect(x + 2*p, y - 2*p, 3*p, 10*p);
            }
            
            drawLeftLegUpDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes - LEFT EYE WINKING!
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 1*p); // Left eye wink (horizontal line)
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p); // Right eye open
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p); // Right eye pupil
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms out
                ctx.fillRect(x - 9*p, y - 14*p, 3*p, 2*p);
                ctx.fillRect(x - 10*p, y - 12*p, 3*p, 6*p);
                ctx.fillRect(x + 6*p, y - 14*p, 3*p, 2*p);
                ctx.fillRect(x + 7*p, y - 12*p, 3*p, 6*p);
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // Left leg KICKED HIGH!
                ctx.fillRect(x - 12*p, y - 8*p, 8*p, 3*p);  // Horizontal leg
                ctx.fillRect(x - 12*p, y - 5*p, 3*p, 3*p);  // Foot
                
                // Right leg standing (thicker for balance)
                ctx.fillRect(x + 1*p, y - 2*p, 4*p, 10*p);
            }
            
            drawWideStanceDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms down at sides
                ctx.fillRect(x - 9*p, y - 10*p, 3*p, 8*p);
                ctx.fillRect(x + 6*p, y - 10*p, 3*p, 8*p);
                
                // Hips wider
                ctx.fillRect(x - 6*p, y - 4*p, 12*p, 2*p);
                
                // Legs WIDE STANCE
                ctx.fillRect(x - 10*p, y - 2*p, 4*p, 10*p); // Left leg far out
                ctx.fillRect(x + 6*p, y - 2*p, 4*p, 10*p);  // Right leg far out
            }
            
            drawRightLegUpDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes - RIGHT EYE WINKING!
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p); // Left eye open
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 1*p); // Right eye wink
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p); // Left eye pupil
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms
                ctx.fillRect(x - 9*p, y - 14*p, 3*p, 2*p);
                ctx.fillRect(x - 10*p, y - 12*p, 3*p, 6*p);
                ctx.fillRect(x + 6*p, y - 14*p, 3*p, 2*p);
                ctx.fillRect(x + 7*p, y - 12*p, 3*p, 6*p);
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // Left leg standing (thicker)
                ctx.fillRect(x - 6*p, y - 2*p, 4*p, 10*p);
                
                // Right leg KICKED HIGH!
                ctx.fillRect(x + 4*p, y - 8*p, 8*p, 3*p);  // Horizontal leg
                ctx.fillRect(x + 9*p, y - 5*p, 3*p, 3*p);  // Foot
            }
            
            drawLeftSquatDemon(ctx, x, y, p) {
                y += 6*p; // Lower position for squat
                
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso - shorter
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 6*p);
                
                // Arms
                ctx.fillRect(x - 9*p, y - 14*p, 3*p, 6*p);
                ctx.fillRect(x + 6*p, y - 14*p, 3*p, 6*p);
                
                // Bent legs - squat position
                ctx.fillRect(x - 6*p, y - 6*p, 3*p, 6*p);
                ctx.fillRect(x + 3*p, y - 6*p, 3*p, 6*p);
            }
            
            drawRightSquatDemon(ctx, x, y, p) {
                y += 6*p; // Lower position
                
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 6*p);
                
                // Arms
                ctx.fillRect(x - 9*p, y - 14*p, 3*p, 6*p);
                ctx.fillRect(x + 6*p, y - 14*p, 3*p, 6*p);
                
                // Bent legs
                ctx.fillRect(x - 6*p, y - 6*p, 3*p, 6*p);
                ctx.fillRect(x + 3*p, y - 6*p, 3*p, 6*p);
            }
            
            drawLeftStompDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes - determined look
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms down with power
                ctx.fillRect(x - 9*p, y - 10*p, 3*p, 8*p);
                ctx.fillRect(x + 6*p, y - 10*p, 3*p, 8*p);
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // LEFT LEG STOMPING - emphasized, thicker
                ctx.fillRect(x - 7*p, y - 2*p, 5*p, 10*p);
                
                // Right leg normal
                ctx.fillRect(x + 2*p, y - 2*p, 3*p, 10*p);
                
                // Impact lines for stomp effect
                ctx.fillStyle = '#8080c0';
                ctx.fillRect(x - 10*p, y + 8*p, 2*p, 1*p);
                ctx.fillRect(x - 12*p, y + 7*p, 2*p, 1*p);
                ctx.fillStyle = '#c0c0ff';
            }
            
            drawRightStompDemon(ctx, x, y, p) {
                // Head
                ctx.fillRect(x - 8*p, y - 30*p, 16*p, 4*p);
                ctx.fillRect(x - 7*p, y - 26*p, 14*p, 2*p);
                ctx.fillRect(x - 6*p, y - 24*p, 12*p, 6*p);
                
                // Horns
                ctx.fillRect(x - 10*p, y - 32*p, 4*p, 2*p);
                ctx.fillRect(x + 6*p, y - 32*p, 4*p, 2*p);
                
                // Eyes
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 5*p, y - 24*p, 3*p, 3*p);
                ctx.fillRect(x + 2*p, y - 24*p, 3*p, 3*p);
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 4*p, y - 23*p, 2*p, 2*p);
                ctx.fillRect(x + 3*p, y - 23*p, 2*p, 2*p);
                ctx.fillStyle = '#c0c0ff';
                
                // Neck
                ctx.fillRect(x - 4*p, y - 18*p, 8*p, 2*p);
                
                // Shoulders
                ctx.fillRect(x - 6*p, y - 16*p, 12*p, 4*p);
                
                // Torso
                ctx.fillRect(x - 3*p, y - 12*p, 6*p, 8*p);
                
                // Arms
                ctx.fillRect(x - 9*p, y - 10*p, 3*p, 8*p);
                ctx.fillRect(x + 6*p, y - 10*p, 3*p, 8*p);
                
                // Hips
                ctx.fillRect(x - 4*p, y - 4*p, 8*p, 2*p);
                
                // Left leg normal
                ctx.fillRect(x - 5*p, y - 2*p, 3*p, 10*p);
                
                // RIGHT LEG STOMPING - emphasized, thicker
                ctx.fillRect(x + 2*p, y - 2*p, 5*p, 10*p);
                
                // Impact lines
                ctx.fillStyle = '#8080c0';
                ctx.fillRect(x + 8*p, y + 8*p, 2*p, 1*p);
                ctx.fillRect(x + 10*p, y + 7*p, 2*p, 1*p);
                ctx.fillStyle = '#c0c0ff';
            }
            
            animate(routine, speed = 100, callback) {
                this.isAnimating = true;
                let moveIndex = 0;
                let frameInMove = 0;
                let frameDelay = speed;
                let lastTime = Date.now();
                let tappedThisMove = false;
                
                const animateFrame = () => {
                    if (!this.isAnimating) {
                        if (callback) callback();
                        return;
                    }
                    
                    const now = Date.now();
                    if (now - lastTime < frameDelay) {
                        this.animationId = requestAnimationFrame(animateFrame);
                        return;
                    }
                    lastTime = now;
                    
                    if (moveIndex >= routine.length) {
                        this.isAnimating = false;
                        if (callback) callback();
                        return;
                    }
                    
                    const moveChar = routine[moveIndex].toUpperCase();
                    const move = this.danceMoves[moveChar];
                    
                    if (move) {
                        const frame = move.frames[frameInMove % move.frames.length];
                        this.drawDemon(frame);
                        
                        // Play tap sound on first frame of tapping moves
                        if (move.hasTap && frameInMove === 0 && !tappedThisMove) {
                            this.tapPlayer.playTap();
                            tappedThisMove = true;
                        }
                        
                        frameInMove++;
                        if (frameInMove >= move.frames.length * 2) { // Each frame shown twice
                            frameInMove = 0;
                            moveIndex++;
                            tappedThisMove = false;
                        }
                    } else {
                        moveIndex++;
                    }
                    
                    this.animationId = requestAnimationFrame(animateFrame);
                };
                
                animateFrame();
            }
            
            stop() {
                this.isAnimating = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                this.drawDemon(0); // Return to neutral pose
            }
        }
        
        // ===========================
        // Main Application
        // ===========================
        
        let app; // Declare globally for access from HTML
        
        app = {
            musicPlayer: null,
            animator: null,
            currentMusic: '',
            currentDance: '',
            isPerforming: false,
            
            init() {
                this.musicPlayer = new MusicPlayer();
                this.animator = new DanceAnimator(document.getElementById('stage'));
                this.setupEventListeners();
                this.loadExamples();
                this.animator.drawDemon(0); // Show neutral pose
                
                // Update character counters
                this.updateMusicLength();
                this.updateDanceLength();
                
                // Initialize visitor tracking
                this.initVisitorTracking();
            },
            
            async initVisitorTracking() {
                // Check if visitor has been here before
                const visitorName = localStorage.getItem('dancing-demon-visitor');
                
                if (!visitorName) {
                    // New visitor - ask for name
                    const name = await this.promptVisitorName();
                    if (name) {
                        localStorage.setItem('dancing-demon-visitor', name);
                        await this.logVisit(name, true);
                    }
                } else {
                    // Returning visitor
                    await this.logVisit(visitorName, false);
                }
                
                // Update visitor count display
                await this.updateVisitorCount();
            },
            
            async promptVisitorName() {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: #1a1a3a;
                            border: 3px solid #8080ff;
                            padding: 30px;
                            border-radius: 10px;
                            max-width: 400px;
                            text-align: center;
                        ">
                            <h2 style="color: #c0c0ff; margin-bottom: 20px;">üé≠ Welcome to Dancing Demon! üé≠</h2>
                            <p style="color: #c0c0ff; margin-bottom: 20px;">
                                Please enter your name to join our audience:
                            </p>
                            <input 
                                type="text" 
                                id="visitor-name-input" 
                                placeholder="Enter your name"
                                style="
                                    width: 100%;
                                    padding: 10px;
                                    font-family: 'Courier New', monospace;
                                    font-size: 16px;
                                    background: #0a0a1a;
                                    color: #c0c0ff;
                                    border: 2px solid #4040a0;
                                    margin-bottom: 20px;
                                "
                            >
                            <button 
                                id="visitor-submit-btn"
                                style="
                                    padding: 12px 24px;
                                    font-family: 'Courier New', monospace;
                                    font-size: 16px;
                                    background: #4040a0;
                                    color: #fff;
                                    border: 2px solid #8080ff;
                                    cursor: pointer;
                                "
                            >Enter Theater</button>
                            <button 
                                id="visitor-skip-btn"
                                style="
                                    padding: 12px 24px;
                                    font-family: 'Courier New', monospace;
                                    font-size: 16px;
                                    background: #2a2a4a;
                                    color: #8080c0;
                                    border: 2px solid #4040a0;
                                    cursor: pointer;
                                    margin-left: 10px;
                                "
                            >Skip</button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    const input = document.getElementById('visitor-name-input');
                    const submitBtn = document.getElementById('visitor-submit-btn');
                    const skipBtn = document.getElementById('visitor-skip-btn');
                    
                    input.focus();
                    
                    const submit = () => {
                        const name = input.value.trim();
                        if (name) {
                            document.body.removeChild(modal);
                            resolve(name);
                        } else {
                            input.style.borderColor = '#ff4040';
                            setTimeout(() => {
                                input.style.borderColor = '#4040a0';
                            }, 500);
                        }
                    };
                    
                    submitBtn.addEventListener('click', submit);
                    skipBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve('Anonymous');
                    });
                    
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') submit();
                    });
                });
            },
            
            async logVisit(name, isNewVisitor) {
                try {
                    await addDoc(collection(db, 'dancingdemon-visitors'), {
                        name: name,
                        timestamp: Timestamp.now(),
                        isNewVisitor: isNewVisitor,
                        userAgent: navigator.userAgent
                    });
                } catch (error) {
                    console.error('Error logging visit:', error);
                }
            },
            
            async updateVisitorCount() {
                try {
                    const visitorSnapshot = await getDocs(collection(db, 'dancingdemon-visitors'));
                    const totalVisits = visitorSnapshot.size;
                    
                    // Count unique visitors
                    const uniqueVisitors = new Set();
                    visitorSnapshot.forEach(doc => {
                        uniqueVisitors.add(doc.data().name);
                    });
                    
                    // Update display
                    const visitorInfo = document.getElementById('visitor-info');
                    if (visitorInfo) {
                        visitorInfo.innerHTML = `
                            üë• <strong>${uniqueVisitors.size}</strong> visitors 
                            | üé≠ <strong>${totalVisits}</strong> total visits
                        `;
                    }
                } catch (error) {
                    console.error('Error updating visitor count:', error);
                }
            },
            
            async refreshVisitorLog() {
                const logContainer = document.getElementById('visitor-log');
                if (!logContainer) return;
                
                logContainer.innerHTML = '<div style="color: #8080c0; text-align: center;">Loading...</div>';
                
                try {
                    const q = query(
                        collection(db, 'dancingdemon-visitors'),
                        orderBy('timestamp', 'desc'),
                        limit(50)
                    );
                    
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        logContainer.innerHTML = '<div style="color: #8080c0; text-align: center;">No visitors yet!</div>';
                        return;
                    }
                    
                    let html = '<div style="font-family: \'Courier New\', monospace; font-size: 0.9em;">';
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate();
                        const timeAgo = this.getTimeAgo(date);
                        const badge = data.isNewVisitor ? 'üÜï' : 'üîÑ';
                        
                        html += `
                            <div style="
                                padding: 8px;
                                margin: 5px 0;
                                background: ${data.isNewVisitor ? '#1a3a1a' : '#1a1a3a'};
                                border-left: 3px solid ${data.isNewVisitor ? '#40a040' : '#4040a0'};
                            ">
                                ${badge} <strong style="color: #c0c0ff;">${data.name}</strong>
                                <span style="color: #8080c0; float: right;">${timeAgo}</span>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    logContainer.innerHTML = html;
                    
                } catch (error) {
                    console.error('Error loading visitor log:', error);
                    logContainer.innerHTML = '<div style="color: #ff6060;">Error loading visitor log</div>';
                }
            },
            
            getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                if (seconds < 60) return 'just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                
                return date.toLocaleDateString();
            },
            
            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
                
                // Performance controls
                document.getElementById('start-show').addEventListener('click', () => this.startShow());
                document.getElementById('stop-show').addEventListener('click', () => this.stopShow());
                document.getElementById('toggle-curtain').addEventListener('click', () => this.toggleCurtain());
                
                // Music controls
                document.getElementById('test-music').addEventListener('click', () => this.testMusic());
                document.getElementById('stop-music').addEventListener('click', () => this.stopMusic());
                document.getElementById('clear-music').addEventListener('click', () => this.clearMusic());
                document.getElementById('music-input').addEventListener('input', () => this.updateMusicLength());
                
                // Dance controls
                document.getElementById('test-dance').addEventListener('click', () => this.testDance());
                document.getElementById('stop-dance').addEventListener('click', () => this.stopDance());
                document.getElementById('clear-dance').addEventListener('click', () => this.clearDance());
                document.getElementById('dance-input').addEventListener('input', () => this.updateDanceLength());
                
                // Example buttons
                document.querySelectorAll('.example-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const example = btn.dataset.example;
                        this.loadExample(example);
                    });
                });
                
                // Save/Load controls
                document.getElementById('save-routine').addEventListener('click', () => this.saveRoutine());
                document.getElementById('load-routine').addEventListener('click', () => this.loadRoutine());
                document.getElementById('export-routine').addEventListener('click', () => this.exportRoutine());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Space bar = start/stop show
                    if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        if (this.isPerforming) {
                            this.stopShow();
                        } else {
                            this.startShow();
                        }
                    }
                    // Escape = stop show
                    if (e.code === 'Escape') {
                        this.stopShow();
                    }
                    // C = toggle curtain
                    if (e.code === 'KeyC' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        this.toggleCurtain();
                    }
                });
            },
            
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active');
                    }
                });
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.dataset.content === tabName) {
                        content.classList.add('active');
                    }
                });
                
                // Refresh visitor log when About tab is opened
                if (tabName === 'about') {
                    this.refreshVisitorLog();
                }
            },
            
            updateMusicLength() {
                const input = document.getElementById('music-input');
                const length = input.value.length;
                document.getElementById('music-length').textContent = length;
                
                if (length > 1000) {
                    input.value = input.value.substring(0, 1000);
                    document.getElementById('music-length').textContent = 1000;
                }
            },
            
            updateDanceLength() {
                const input = document.getElementById('dance-input');
                const length = input.value.length;
                document.getElementById('dance-length').textContent = length;
                
                if (length > 255) {
                    input.value = input.value.substring(0, 255);
                    document.getElementById('dance-length').textContent = 255;
                }
            },
            
            testMusic() {
                const music = document.getElementById('music-input').value;
                if (!music) {
                    alert('Please enter a musical score first!');
                    return;
                }
                this.musicPlayer.playSequence(music);
            },
            
            stopMusic() {
                this.musicPlayer.stop();
            },
            
            clearMusic() {
                document.getElementById('music-input').value = '';
                this.updateMusicLength();
            },
            
            testDance() {
                const dance = document.getElementById('dance-input').value;
                if (!dance) {
                    alert('Please enter a dance routine first!');
                    return;
                }
                
                // Switch to performance tab
                this.switchTab('performance');
                
                // Show curtain
                const curtain = document.getElementById('curtain');
                const stageInfo = document.getElementById('stage-info');
                stageInfo.textContent = 'üé≠ REHEARSAL - Dance Preview üé≠';
                stageInfo.style.color = '#ffcc00';
                
                curtain.style.display = 'block';
                curtain.classList.add('closed');
                curtain.classList.remove('opening');
                
                // Open curtain after brief pause
                setTimeout(() => {
                    curtain.classList.remove('closed');
                    curtain.classList.add('opening');
                    
                    setTimeout(() => {
                        curtain.style.display = 'none';
                        
                        // Start dance preview
                        const speed = parseInt(document.getElementById('speed-factor').value) || 100;
                        this.animator.animate(dance, speed, () => {
                            // Close curtain at end
                            this.closeCurtainSlowly(() => {
                                stageInfo.textContent = 'Belvedere Theater, Oskowatcha, Washington';
                                stageInfo.style.color = '#c0c0ff';
                            });
                        });
                    }, 1000);
                }, 500);
            },
            
            closeCurtainSlowly(callback) {
                const curtain = document.getElementById('curtain');
                curtain.style.display = 'block';
                curtain.classList.remove('closed', 'opening');
                
                // Animate closing
                curtain.style.transform = 'scaleY(0)';
                curtain.style.transformOrigin = 'top';
                
                setTimeout(() => {
                    curtain.style.transition = 'transform 2s ease-in-out';
                    curtain.style.transform = 'scaleY(1)';
                }, 50);
                
                setTimeout(() => {
                    curtain.classList.add('closed');
                    if (callback) callback();
                }, 2100);
            },
            
            stopDance() {
                this.animator.stop();
            },
            
            clearDance() {
                document.getElementById('dance-input').value = '';
                this.updateDanceLength();
            },
            
            toggleCurtain() {
                const curtain = document.getElementById('curtain');
                const isClosed = curtain.style.display === 'none' || curtain.classList.contains('opening');
                
                if (isClosed) {
                    // Close curtain
                    curtain.style.display = 'block';
                    curtain.classList.remove('opening');
                    curtain.classList.add('closed');
                } else {
                    // Open curtain
                    curtain.classList.remove('closed');
                    curtain.classList.add('opening');
                    setTimeout(() => {
                        curtain.style.display = 'none';
                    }, 1000);
                }
            },
            
            startShow() {
                const music = document.getElementById('music-input').value;
                const dance = document.getElementById('dance-input').value;
                
                if (!music || !dance) {
                    alert('Please compose music and choreograph a dance first!');
                    return;
                }
                
                this.switchTab('performance');
                
                // Show "SHOW STARTING" message
                const stageInfo = document.getElementById('stage-info');
                stageInfo.textContent = 'üé¨ SHOW STARTING... üé¨';
                stageInfo.style.color = '#ffff00';
                stageInfo.style.textShadow = '0 0 10px #ffff00';
                
                // Close curtain first
                const curtain = document.getElementById('curtain');
                curtain.style.display = 'block';
                curtain.classList.add('closed');
                curtain.classList.remove('opening');
                
                // Wait a moment, then open curtain and start performance
                setTimeout(() => {
                    stageInfo.textContent = 'üé≠ CURTAIN RISING üé≠';
                    
                    curtain.classList.remove('closed');
                    curtain.classList.add('opening');
                    
                    setTimeout(() => {
                        this.performShow(music, dance);
                    }, 1000);
                }, 1000);
            },
            
            performShow(music, dance) {
                const speed = parseInt(document.getElementById('speed-factor').value) || 100;
                const performances = parseInt(document.getElementById('num-performances').value) || 1;
                let currentPerformance = 0;
                
                // Show "NOW PERFORMING" indicator
                const stageInfo = document.getElementById('stage-info');
                const originalText = stageInfo.textContent;
                
                const performNext = () => {
                    if (currentPerformance >= performances) {
                        this.isPerforming = false;
                        
                        // Close curtain at end of all performances
                        this.closeCurtainSlowly(() => {
                            stageInfo.textContent = originalText;
                            stageInfo.style.color = '#c0c0ff';
                            stageInfo.style.textShadow = 'none';
                        });
                        return;
                    }
                    
                    this.isPerforming = true;
                    currentPerformance++;
                    
                    // Update performance indicator
                    stageInfo.textContent = `üé≠ NOW PERFORMING üé≠ (${currentPerformance}/${performances})`;
                    stageInfo.style.color = '#ffff00';
                    stageInfo.style.textShadow = '0 0 10px #ffff00';
                    
                    // Calculate how many times to loop the dance to match music length
                    const musicDuration = music.length;
                    const danceDuration = this.calculateDanceDuration(dance);
                    const danceLoops = Math.ceil(musicDuration / danceDuration);
                    
                    // Create looped dance
                    let fullDance = '';
                    for (let i = 0; i < danceLoops; i++) {
                        fullDance += dance;
                    }
                    
                    // Start music and animation simultaneously
                    this.musicPlayer.playSequence(music);
                    this.animator.animate(fullDance, speed, performNext);
                };
                
                performNext();
            },
            
            calculateDanceDuration(dance) {
                let total = 0;
                for (let char of dance.toUpperCase()) {
                    const move = this.animator.danceMoves[char];
                    if (move) {
                        total += move.duration;
                    }
                }
                return total;
            },
            
            stopShow() {
                this.isPerforming = false;
                this.musicPlayer.stop();
                this.animator.stop();
                
                // Reset stage info
                const stageInfo = document.getElementById('stage-info');
                stageInfo.textContent = 'Belvedere Theater, Oskowatcha, Washington';
                stageInfo.style.color = '#c0c0ff';
                stageInfo.style.textShadow = 'none';
            },
            
            loadExamples() {
                this.examples = {
                    'aint-she-sweet': {
                        name: "Ain't She Sweet",
                        music: 'T192 [C,E,G,O3E]8 [O4C,E,A] P16 [O3B,O4F,G]2 O3 D8 P16 C#8 P16 [A,O4C,F,O3C]8 [A,O4C,F] P16 [O3G#,O4D,E]2 O2 B8 P16 A#8 P16 [O4C,O3G,E,O2A]4 O4 D8 [C,E,O3G]4 O4 G8 [C,E,B,O3D] P16 [O4C,D,F,A]4 P16 [O3B,O4D#,F,G#]2 P16 [G,C,E,O3C]4 [O4A,C,E]8 P16 [C,E,G]4 [O3A#,O4E,O3C#]8 P16 [O4G,O3B,O4F,O3D]4 [O4A,O3B,O4F]8 P16 [G,O3B,O4F]2 O2 G8 P16 [O4G,C,E,O3G]8 P16 [O4A,C,D#,O3F#]8 P16 [O4G,C,E,O3G]8 P16 [O4A,O3B,O4D#,O3F]8 P16 [O4G,C,E,O3C]8 [O5C,O4A,O3D,F] P16 [E,G,O4G,C]2 O2 G8 P16 [O4E,O3A,O4C,O2A]4 [O4F,O3A,O4C]8 P16 [E,O3A,O4C]2 O3 C8 P16 [O4E,O3G#,O4D,O2B]4 [O4F,O3G#,O4D]8 P16 [E,O3G#,O4D]2 O2 E8 P16 [O4E,O3A,O4C,O3E]8 P16 [O4F,O3A,O4C,O3D#]8 P16 [O4E,O3A,O4C,O3E]8 P16 [O4F,O3A,B,D]8 P16 [O4E,O3A,O4C,O2A]8 [O4A,F,O2B,O3D] P16 [C,E,O4E,O3A]2 O2 E8 P16 [D,O3D,O4G]4 [O3F,B]2 [O4F,O1G,O2G]8 P16 [O4D,O3F,B]8 P16 [B,O2G,O4G,O3F]2 [O4C,O2A]8 P16 [O4C#,O2A#]8 P16 [O4D,O2B]8 P16 [O4A,O3C]2 [O4C,E] [G,O2A#]4 [O4E,O3G,O4D]8 P16 [O3A,O4C#,A,O2A]2 [O3B,O4D]8 P16 [C,D#]8 P16 [C#,E]8 P16 [O2D,O3D]2 [O4B,O3B,O4D,G]8 P16 [A,C,D,F#]8 P16 [G,O3B,O4D]8 P16 [O2E,O3E]2 [O4B,O3B,O4E,G]8 P16 [A,C,D#,F#]8 P16 [G,O3B,O4E]8 P16 [C,E,O2A,O3G]2 O5 C8 P16 [O4B,C,D#,O3D]4 O4 A8 P16 [C,G,O2G,O3F]2 A8 P16 A#8 P16 B8 P16 [O4A,E,O2C]2 O3 A8 P16 [A#,O4E,G#,O2C#]4 [O3A#,O4E]8 P16 [C,O2D,O4G,F]4 O3 A8 B2 O2 G8 [O4A,F] P16 G8 [A,O3A,O4E,O2C]4 O4 A8 P16 [G#,O3A#,O4E,O2C#]4 O4 G#8 P16 [C,O2D,O4G,F]4 O3 A8 B2 [O1G,O2G]8 [O4A,F] P16 G8',
                        dance: 'AABBCCDDEEFFGGHHSSTQRAABBCCDDEEFFGGHHIJKLMNOPQRST'
                    },
                    'encore': {
                        name: "Encore Performance",
                        music: 'T120 O4 L4 [C,E,G]4 [D,F,A]4 [E,G,B]4 [F,A,O5C]4 [G,B,O5D]4 [C,E,O5G]2',
                        dance: 'GHIJKLMNOPQRST'
                    },
                    'simple-demo': {
                        name: "Simple Demo",
                        music: 'T120 O4 L4 C D E F G A B O5 C',
                        dance: 'ABCDABCD'
                    },
                    'jazz-hands': {
                        name: "Jazz Hands",
                        music: 'T140 O4 L8 [C,E,G] [C,E,G] [D,F,A] [D,F,A] [E,G,B] [E,G,B] [F,A,O5C]2',
                        dance: 'IJIJIJIJIJ'
                    },
                    'stomp-fest': {
                        name: "Stomp Fest",
                        music: 'T100 O3 L4 C C C C G G G G',
                        dance: 'GHLMGHLMST'
                    },
                    'wave-dance': {
                        name: "Wave Dance",
                        music: 'T130 O4 L8 C E G O5 C O4 B G E C',
                        dance: 'IJIJSTIJIJ'
                    }
                };
            },
            
            loadExample(exampleName) {
                const example = this.examples[exampleName];
                if (!example) return;
                
                document.getElementById('music-input').value = example.music;
                document.getElementById('dance-input').value = example.dance;
                this.updateMusicLength();
                this.updateDanceLength();
                
                // Auto-switch to performance tab
                this.switchTab('performance');
                
                // Wait a brief moment then start the show automatically
                setTimeout(() => {
                    this.startShow();
                }, 300);
            },
            
            saveRoutine() {
                const music = document.getElementById('music-input').value;
                const dance = document.getElementById('dance-input').value;
                
                if (!music || !dance) {
                    alert('Please create music and dance routines first!');
                    return;
                }
                
                const name = prompt('Enter a name for this routine:');
                if (!name) return;
                
                const routine = { name, music, dance };
                localStorage.setItem('dancing-demon-' + name, JSON.stringify(routine));
                
                alert('Routine saved! Use "Load Saved Routine" to retrieve it later.');
            },
            
            loadRoutine() {
                const name = prompt('Enter the name of the routine to load:');
                if (!name) return;
                
                const saved = localStorage.getItem('dancing-demon-' + name);
                if (!saved) {
                    alert('Routine not found!');
                    return;
                }
                
                const routine = JSON.parse(saved);
                document.getElementById('music-input').value = routine.music;
                document.getElementById('dance-input').value = routine.dance;
                this.updateMusicLength();
                this.updateDanceLength();
                
                alert('Routine loaded!');
            },
            
            exportRoutine() {
                const music = document.getElementById('music-input').value;
                const dance = document.getElementById('dance-input').value;
                
                if (!music || !dance) {
                    alert('Please create music and dance routines first!');
                    return;
                }
                
                const exportText = `DANCING DEMON ROUTINE
=====================================
Music: ${music}
Dance: ${dance}
=====================================
Copy this text to share with others!`;
                
                document.getElementById('export-text').value = exportText;
                document.getElementById('export-output').style.display = 'block';
                document.getElementById('export-text').select();
            }
        };
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>
