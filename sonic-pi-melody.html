<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Pi Melody</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
        }
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            margin: 10px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .info {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }
        .now-playing {
            font-weight: bold;
            color: #667eea;
            margin-top: 20px;
            min-height: 24px;
        }
        .controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Sonic Pi Melody</h1>
        <div class="controls">
            <button id="playBtn">Play</button>
            <button id="stopBtn" disabled>Stop</button>
        </div>
        <div class="now-playing" id="status"></div>
        <div class="info">
            <strong>Info:</strong><br>
            BPM: 86<br>
            Synth: FM Synthesis<br>
            Key: Bb minor
        </div>
    </div>

    <script>
        let audioContext;
        let isPlaying = false;
        let scheduledNodes = [];

        // Note name to frequency conversion
        const noteFrequencies = {
            'C': 261.63, 'Db': 277.18, 'D': 293.66, 'Eb': 311.13,
            'E': 329.63, 'F': 349.23, 'Gb': 369.99, 'G': 392.00,
            'Ab': 415.30, 'A': 440.00, 'Bb': 466.16, 'B': 493.88
        };

        function getNoteFrequency(note) {
            const match = note.match(/([A-G][b#]?)(\d)/);
            if (!match) return 440;
            
            const [, noteName, octave] = match;
            const baseFreq = noteFrequencies[noteName];
            const octaveOffset = parseInt(octave) - 4;
            
            return baseFreq * Math.pow(2, octaveOffset);
        }

        // Dynamic value function (normalize MIDI velocity)
        function dynamicValue(d) {
            return d / 127.0;
        }

        // Convert beats to seconds at BPM 86
        function beatsToSeconds(beats) {
            return (beats * 60) / 86;
        }

        // Create FM synthesizer
        function playFMNote(freq, startTime, duration, amp = 1.0) {
            const ctx = audioContext;
            
            // Carrier oscillator
            const carrier = ctx.createOscillator();
            carrier.type = 'sine';
            carrier.frequency.setValueAtTime(freq, startTime);
            
            // Modulator oscillator (FM synthesis)
            const modulator = ctx.createOscillator();
            modulator.type = 'sine';
            modulator.frequency.setValueAtTime(freq * 2, startTime); // 2:1 ratio
            
            // Modulation amount
            const modulatorGain = ctx.createGain();
            modulatorGain.gain.setValueAtTime(freq * 0.5, startTime); // Modulation depth
            
            // Output gain with envelope
            const outputGain = ctx.createGain();
            outputGain.gain.setValueAtTime(0, startTime);
            
            // ADSR envelope
            const attack = 0.01;
            const decay = 0.1;
            const sustain = amp * 0.3;
            const release = 0.2;
            
            outputGain.gain.linearRampToValueAtTime(amp * 0.4, startTime + attack);
            outputGain.gain.exponentialRampToValueAtTime(sustain, startTime + attack + decay);
            outputGain.gain.setValueAtTime(sustain, startTime + duration - release);
            outputGain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            
            // Connect the FM synthesis chain
            modulator.connect(modulatorGain);
            modulatorGain.connect(carrier.frequency);
            carrier.connect(outputGain);
            outputGain.connect(ctx.destination);
            
            // Start and stop
            carrier.start(startTime);
            modulator.start(startTime);
            carrier.stop(startTime + duration);
            modulator.stop(startTime + duration);
            
            scheduledNodes.push({ carrier, modulator, gain: outputGain });
        }

        // Play a pattern of notes with timing
        function playPattern(notes, timings, amp, startTime) {
            let currentTime = startTime;
            
            notes.forEach((note, i) => {
                const freq = getNoteFrequency(note);
                const duration = beatsToSeconds(timings[i]);
                playFMNote(freq, currentTime, duration, amp);
                currentTime += duration;
            });
            
            return currentTime;
        }

        // Main playback function
        function playMelody() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const amp = dynamicValue(105.56);
            let time = audioContext.currentTime + 0.1;

            // First pattern
            time = playPattern(
                ['Bb4', 'Db5', 'C5', 'Eb5', 'Ab4', 'Gb4'],
                [1.5, 0.5, 0.5, 0.5, 0.5, 0.5],
                amp,
                time
            );

            // F4 sustained for 4 beats
            playFMNote(getNoteFrequency('F4'), time, beatsToSeconds(4), amp);
            time += beatsToSeconds(4);

            // Sleep 4 beats
            time += beatsToSeconds(4);

            // F4 sustained for 4 beats again
            playFMNote(getNoteFrequency('F4'), time, beatsToSeconds(4), amp);
            time += beatsToSeconds(4);

            // Sleep 4 beats
            time += beatsToSeconds(4);

            // Second pattern
            time = playPattern(
                ['Bb4', 'Db5', 'C5', 'Eb5', 'Ab5', 'Gb5'],
                [1.5, 0.5, 0.5, 0.5, 0.5, 0.5],
                amp,
                time
            );

            // Third pattern
            time = playPattern(
                ['F5', 'Bb4', 'Bb4', 'C5'],
                [2, 2, 1, 1],
                amp,
                time
            );

            // Fourth pattern
            time = playPattern(
                ['C5', 'Eb5', 'Ab5', 'Gb5', 'F5'],
                [0.5, 0.5, 0.5, 0.5, 2],
                amp,
                time
            );

            // Calculate total duration
            const totalDuration = (time - audioContext.currentTime) * 1000;

            // Update UI
            document.getElementById('status').textContent = 'â™ª Playing...';
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            isPlaying = true;

            // Auto-stop when finished
            setTimeout(() => {
                if (isPlaying) {
                    stopPlayback();
                }
            }, totalDuration);
        }

        function stopPlayback() {
            // Stop all scheduled nodes
            scheduledNodes.forEach(({carrier, modulator, gain}) => {
                try {
                    carrier.stop();
                    modulator.stop();
                } catch (e) {
                    // Already stopped
                }
            });
            scheduledNodes = [];

            // Reset UI
            document.getElementById('status').textContent = '';
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            isPlaying = false;
        }

        // Button event listeners
        document.getElementById('playBtn').addEventListener('click', () => {
            playMelody();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            stopPlayback();
        });
    </script>
</body>
</html>
