<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWBASIC PLAY Command Player v3.0</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a2a0a 100%);
            color: #00ff00;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00, 0 0 40px #00aa00;
            font-size: 36px;
            margin: 20px 0;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff00, 0 0 20px #00aa00; }
            to { text-shadow: 0 0 20px #00ff00, 0 0 40px #00aa00, 0 0 60px #008800; }
        }
        .version {
            text-align: center;
            color: #ffff00;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .container {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #00ff00;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }
        .editor-section {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .editor-section {
                grid-template-columns: 1fr;
            }
        }
        textarea {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: #0a0a0a;
            color: #00ff00;
            border: 2px solid #00ff00;
            border-radius: 5px;
            min-height: 150px;
            resize: vertical;
            line-height: 1.6;
        }
        textarea:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .controls {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #006600;
        }
        .controls h3 {
            margin-top: 0;
            color: #00ff00;
            font-size: 16px;
        }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #00cc00;
        }
        select, input[type="range"], input[type="number"] {
            width: 100%;
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        input[type="range"] {
            padding: 0;
        }
        .slider-value {
            text-align: right;
            font-size: 14px;
            color: #ffff00;
            margin-top: 5px;
        }
        button {
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            background: linear-gradient(135deg, #00ffff 0%, #00aaaa 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 255, 255, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #006600;
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        button.stop-btn {
            background: linear-gradient(135deg, #ff0000 0%, #aa0000 100%);
            color: #fff;
        }
        button.stop-btn:hover {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .visualizer {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .visualizer canvas {
            width: 100%;
            height: 80px;
            border-radius: 3px;
        }
        .now-playing {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #00ff00;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .now-playing-info {
            flex: 1;
        }
        .now-playing-label {
            font-size: 12px;
            color: #888;
        }
        .now-playing-text {
            font-size: 18px;
            color: #00ff00;
            font-weight: bold;
            margin-top: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0a0a0a;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #00ffff 100%);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .example {
            background: #0a0a0a;
            border: 2px solid #006600;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .example:hover {
            border-color: #00ff00;
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
        }
        .example.selected {
            border-color: #00ffff;
            background: #1a3a3a;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .example h4 {
            margin: 0 0 10px 0;
            color: #00ff00;
            font-size: 14px;
        }
        .example .tag {
            display: inline-block;
            background: #006600;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 8px;
            color: #00ff00;
        }
        .example .notation {
            font-size: 11px;
            color: #00aa00;
            margin-top: 8px;
            word-break: break-all;
            max-height: 60px;
            overflow: hidden;
        }
        .info-box {
            background: #0a0a0a;
            padding: 20px;
            border: 1px solid #006600;
            border-radius: 5px;
            margin-top: 20px;
            line-height: 1.8;
        }
        .info-box h3 {
            color: #00ff00;
            margin-top: 0;
        }
        .info-box strong {
            color: #00ffff;
        }
        .feature-highlight {
            color: #ffff00;
            font-weight: bold;
        }
        .keyboard {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            height: 100px;
            position: relative;
        }
        .key {
            width: 40px;
            height: 100px;
            background: #fff;
            border: 1px solid #000;
            border-radius: 0 0 3px 3px;
            position: relative;
            transition: all 0.1s;
        }
        .key.black {
            width: 25px;
            height: 60px;
            background: #000;
            border: 1px solid #00ff00;
            position: absolute;
            z-index: 2;
            margin-left: -12.5px;
        }
        .key.active {
            background: #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }
        .key.black.active {
            background: #00ffff;
            box-shadow: 0 0 20px #00ffff;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            background: #0a0a0a;
            border: 1px solid #006600;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            color: #00ff00;
            font-weight: bold;
        }
        .stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }
        .tab-container {
            margin: 20px 0;
        }
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #006600;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #0a0a0a;
            border: 1px solid #006600;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            color: #00aa00;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #1a1a1a;
            color: #00ff00;
        }
        .tab.active {
            background: #1a3a1a;
            color: #00ff00;
            border-color: #00ff00;
            position: relative;
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #1a3a1a;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>‚ô™ GWBASIC PLAY COMMAND PLAYER ‚ô™</h1>
    <div class="version">Version 3.0 - Enhanced Edition</div>
    
    <div class="container">
        <div class="now-playing">
            <div class="now-playing-info">
                <div class="now-playing-label">NOW PLAYING</div>
                <div class="now-playing-text" id="nowPlaying">Ready...</div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="statTempo">120</div>
                <div class="stat-label">TEMPO (BPM)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statOctave">4</div>
                <div class="stat-label">OCTAVE</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statLength">4</div>
                <div class="stat-label">NOTE LENGTH</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statNotes">0</div>
                <div class="stat-label">NOTES PLAYED</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="editor-section">
            <div>
                <label for="playString" style="display: block; margin-bottom: 10px; font-size: 16px;">
                    <strong>PLAY Command String:</strong>
                </label>
                <textarea id="playString" placeholder="T120 O4 L4 [C,E,G] [D,F,A] [E,G,B] [C,E,G]">T120 O4 L4 [C,E,G] [D,F,A] [E,G,B] [C,E,G]</textarea>
            </div>
            
            <div class="controls">
                <h3>‚öôÔ∏è SETTINGS</h3>
                
                <div class="control-group">
                    <label>Wave Type:</label>
                    <select id="waveType">
                        <option value="square">Square (Classic GWBASIC)</option>
                        <option value="sine" selected>Sine (Smooth)</option>
                        <option value="sawtooth">Sawtooth (Bright)</option>
                        <option value="triangle">Triangle (Soft)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Master Volume:</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="70">
                    <div class="slider-value"><span id="volumeValue">70</span>%</div>
                </div>
                
                <div class="control-group">
                    <label>Reverb:</label>
                    <input type="range" id="reverbSlider" min="0" max="100" value="20">
                    <div class="slider-value"><span id="reverbValue">20</span>%</div>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="playBtn">‚ñ∂ PLAY</button>
            <button id="stopBtn" class="stop-btn" disabled>‚èπ STOP</button>
            <button id="clearBtn">üóëÔ∏è CLEAR</button>
            <button id="copyBtn">üìã COPY</button>
            <button id="saveBtn">üíæ SAVE</button>
            <button id="loadBtn">üìÅ LOAD</button>
        </div>
    </div>

    <div class="container">
        <div class="visualizer">
            <canvas id="visualizerCanvas" width="1000" height="80"></canvas>
        </div>
    </div>

    <div class="container tab-container">
        <div class="tabs">
            <div class="tab active" data-tab="examples">üìö EXAMPLES</div>
            <div class="tab" data-tab="reference">üìñ REFERENCE</div>
            <div class="tab" data-tab="changelog">üìã CHANGELOG</div>
        </div>
        
        <div class="tab-content active" data-content="examples">
            <div class="examples">
                <div class="example" data-notation="T120 O4 L4 [C,E,G] [D,F,A] [E,G,B] [C,E,G]">
                    <h4>Basic Chords <span class="tag">EASY</span></h4>
                    <div class="notation">T120 O4 L4 [C,E,G] [D,F,A] [E,G,B] [C,E,G]</div>
                </div>
                
                <div class="example" data-notation="T140 O4 L8 [C,E] [C,E] [G,O5C] [G,O5C] [A,O5C] [A,O5C] [G,B]2 [F,A] [F,A] [E,G] [E,G] [D,F] [D,F] [C,E]2">
                    <h4>Twinkle Twinkle <span class="tag">CLASSIC</span></h4>
                    <div class="notation">T140 O4 L8 [C,E] [C,E] [G,O5C] [G,O5C]...</div>
                </div>
                
                <div class="example" data-notation="T120 O2 L4 [C,O4C,E,G] [G,O4C,E,G] [C,O4C,E,G] [G,O4C,E,G] [F,O4C,F,A] [C,O4C,F,A] [C,O4C,E,G] [G,O4B,D,F]">
                    <h4>Stride Piano <span class="tag">PIANO</span></h4>
                    <div class="notation">T120 O2 L4 [C,O4C,E,G] [G,O4C,E,G]...</div>
                </div>
                
                <div class="example" data-notation="T340 O4 L4 E E P E P C E P G2 P2 O3 G2 P2">
                    <h4>Super Mario <span class="tag">GAME</span></h4>
                    <div class="notation">T140 O4 L4 E E P E P C E P G2...</div>
                </div>
                
                <div class="example" data-notation="T100 O3 L4 [C,E,G] [C,E,G] [C,E,G] [C,E,G] [F,A,O4C] [F,A,O4C] [C,E,G] [C,E,G] [G,B,O4D] [F,A,O4C] [C,E,G] [G,B,O4D]">
                    <h4>12-Bar Blues <span class="tag">JAZZ</span></h4>
                    <div class="notation">T100 O3 L4 [C,E,G] [C,E,G] [C,E,G]...</div>
                </div>
                
                <div class="example" data-notation="T120 O4 L4 E E F G G F E D C C D E E8 D16 D2 E E F G G F E D C C D E D8 C16 C2">
                    <h4>Ode to Joy <span class="tag">CLASSICAL</span></h4>
                    <div class="notation">T120 O4 L4 E E F G G F E D C C D E...</div>
                </div>
                
                <div class="example" data-notation="T200 O5 L16 C D E F G A B O6 C O5 B A G F E D C">
                    <h4>Fast Scale <span class="tag">EXERCISE</span></h4>
                    <div class="notation">T200 O5 L16 C D E F G A B O6 C...</div>
                </div>
                
                <div class="example" data-notation="T140 O4 L8 G A L16 C C C C C C C C C L8 [G,A] [G,A] C C L16 C C C C C C L8 [G,A] [G,A] L16 C C C C C C C C C C C L4 B2 L8 [G,A] [G,A]">
                    <h4>Baby Shark <span class="tag">KIDS</span></h4>
                    <div class="notation">T140 O4 L8 G A L16 C C C C C C...</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" data-content="reference">
            <div class="info-box">
                <h3>Command Reference:</h3>
                <p><strong>T</strong>nnn - Tempo (beats per minute, 32-255, default 120)</p>
                <p><strong>O</strong>n - Octave (0-6, default 4, 4 is middle octave)</p>
                <p><strong>L</strong>n - Default note Length (1=whole, 2=half, 4=quarter, 8=eighth, 16=sixteenth)</p>
                <p><strong>A-G</strong> - Notes (can add # or + for sharp, - for flat)</p>
                <p><strong>P</strong> - Pause/rest</p>
                <p><strong>Number after note</strong> - Duration override (e.g., C8 = eighth note C)</p>
                
                <h3 style="margin-top: 30px;">Chord Syntax:</h3>
                <p><strong>[note1,note2,note3]</strong> - Play notes as chord</p>
                <p><strong>[C,E,G]4</strong> - C major triad, quarter note</p>
                <p><strong>[E,O5C#]2</strong> - E4 and C#5 together, half note</p>
                <p><strong>[O2C,O4C,E,G]</strong> - Bass + chord (wide octave spread for piano)</p>
                
                <h3 style="margin-top: 30px;">Examples:</h3>
                <p><span class="feature-highlight">Simple melody:</span> T120 O4 L4 C D E F G</p>
                <p><span class="feature-highlight">With chords:</span> T120 O4 L4 [C,E,G] [D,F,A] [E,G,B]</p>
                <p><span class="feature-highlight">Piano style:</span> T120 O2 L4 [C,O4C,E,G] [G,O4B,D,F]</p>
                <p><span class="feature-highlight">Mixed durations:</span> T120 O4 L4 C8 D8 E4 F2</p>
            </div>
        </div>
        
        <div class="tab-content" data-content="changelog">
            <div class="info-box">
                <h3>Version 3.0 - Enhanced Edition</h3>
                <p><span class="feature-highlight">NEW:</span> Real-time visualizer with waveform display</p>
                <p><span class="feature-highlight">NEW:</span> Multiple waveform types (sine, square, sawtooth, triangle)</p>
                <p><span class="feature-highlight">NEW:</span> Master volume and reverb controls</p>
                <p><span class="feature-highlight">NEW:</span> Progress bar showing playback position</p>
                <p><span class="feature-highlight">NEW:</span> Live statistics (tempo, octave, note count)</p>
                <p><span class="feature-highlight">NEW:</span> Save/load compositions</p>
                <p><span class="feature-highlight">NEW:</span> Tabbed interface for better organization</p>
                <p><span class="feature-highlight">NEW:</span> Grid-based example gallery</p>
                <p><span class="feature-highlight">IMPROVED:</span> Better visual design with animations</p>
                <p><span class="feature-highlight">IMPROVED:</span> Enhanced sound quality</p>
                
                <h3 style="margin-top: 30px;">Version 2.0</h3>
                <p>Fixed octave+note notation (e.g., [O2C,O5C])</p>
                <p>Added wide octave support for piano music</p>
                
                <h3 style="margin-top: 30px;">Version 1.0</h3>
                <p>Initial release with chord support</p>
            </div>
        </div>
    </div>

    <script>
        class GWBasicChordPlayerV3 {
            constructor() {
                this.audioContext = null;
                this.tempo = 120;
                this.octave = 4;
                this.defaultLength = 4;
                this.isPlaying = false;
                this.scheduledNodes = [];
                this.waveType = 'sine';
                this.masterVolume = 0.7;
                this.reverbAmount = 0.2;
                this.startTime = 0;
                this.totalDuration = 0;
                this.notesPlayed = 0;
                this.analyser = null;
                this.visualizerRunning = false;
            }

            noteFrequencies = {
                'C': 261.63, 'C#': 277.18, 'Db': 277.18, 'D': 293.66,
                'D#': 311.13, 'Eb': 311.13, 'E': 329.63, 'F': 349.23,
                'F#': 369.99, 'Gb': 369.99, 'G': 392.00, 'G#': 415.30,
                'Ab': 415.30, 'A': 440.00, 'A#': 466.16, 'Bb': 466.16, 'B': 493.88
            };

            getFrequency(note, octave) {
                const baseFreq = this.noteFrequencies[note];
                if (!baseFreq) return 0;
                return baseFreq * Math.pow(2, octave - 4);
            }

            getDuration(length) {
                const quarterNoteDuration = 60 / this.tempo;
                return (4 / length) * quarterNoteDuration;
            }

            parsePlayString(playString) {
                const commands = [];
                playString = playString.toUpperCase().replace(/\s+/g, '');
                
                let i = 0;
                while (i < playString.length) {
                    const char = playString[i];
                    
                    if (char === 'T') {
                        i++;
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        commands.push({ type: 'TEMPO', value: parseInt(num) || 120 });
                    }
                    else if (char === 'O') {
                        i++;
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        commands.push({ type: 'OCTAVE', value: parseInt(num) || 4 });
                    }
                    else if (char === 'L') {
                        i++;
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        commands.push({ type: 'LENGTH', value: parseInt(num) || 4 });
                    }
                    else if (char === 'P') {
                        i++;
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        commands.push({ type: 'PAUSE', length: num ? parseInt(num) : null });
                    }
                    else if (char === '[') {
                        i++;
                        let chordStr = '';
                        while (i < playString.length && playString[i] !== ']') {
                            chordStr += playString[i++];
                        }
                        i++;
                        
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        
                        const noteStrings = chordStr.split(',');
                        const notes = [];
                        let currentOctave = this.octave;
                        
                        for (let noteStr of noteStrings) {
                            noteStr = noteStr.trim();
                            
                            let noteOctave = currentOctave;
                            let noteStart = 0;
                            
                            if (noteStr[0] === 'O' && noteStr.length > 1 && /\d/.test(noteStr[1])) {
                                noteOctave = parseInt(noteStr[1]) || currentOctave;
                                currentOctave = noteOctave;
                                noteStart = 2;
                            }
                            
                            if (noteStart < noteStr.length && /[A-G]/.test(noteStr[noteStart])) {
                                let note = noteStr[noteStart];
                                let idx = noteStart + 1;
                                
                                if (idx < noteStr.length && (noteStr[idx] === '#' || noteStr[idx] === '+')) {
                                    note += '#';
                                    idx++;
                                } else if (idx < noteStr.length && noteStr[idx] === '-') {
                                    note += 'b';
                                    idx++;
                                }
                                
                                notes.push({ note: note, octave: noteOctave });
                            }
                        }
                        
                        commands.push({ type: 'CHORD', notes: notes, length: num ? parseInt(num) : null });
                    }
                    else if (/[A-G]/.test(char)) {
                        let note = char;
                        i++;
                        
                        if (i < playString.length && (playString[i] === '#' || playString[i] === '+')) {
                            note += '#';
                            i++;
                        } else if (i < playString.length && playString[i] === '-') {
                            note += 'b';
                            i++;
                        }
                        
                        let num = '';
                        while (i < playString.length && /\d/.test(playString[i])) {
                            num += playString[i++];
                        }
                        
                        commands.push({ type: 'NOTE', note: note, length: num ? parseInt(num) : null });
                    }
                    else {
                        i++;
                    }
                }
                
                return commands;
            }

            updateStats() {
                document.getElementById('statTempo').textContent = this.tempo;
                document.getElementById('statOctave').textContent = this.octave;
                document.getElementById('statLength').textContent = this.defaultLength;
                document.getElementById('statNotes').textContent = this.notesPlayed;
            }

            startVisualizer() {
                if (!this.analyser || this.visualizerRunning) return;
                
                this.visualizerRunning = true;
                const canvas = document.getElementById('visualizerCanvas');
                const ctx = canvas.getContext('2d');
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    if (!this.visualizerRunning) return;
                    
                    requestAnimationFrame(draw);
                    
                    this.analyser.getByteTimeDomainData(dataArray);
                    
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#00ff00';
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#00ff00';
                    
                    ctx.beginPath();
                    
                    const sliceWidth = canvas.width / bufferLength;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * canvas.height / 2;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                        
                        x += sliceWidth;
                    }
                    
                    ctx.lineTo(canvas.width, canvas.height / 2);
                    ctx.stroke();
                };
                
                draw();
            }

            updateProgress() {
                if (!this.isPlaying || !this.audioContext) return;
                
                const elapsed = this.audioContext.currentTime - this.startTime;
                const progress = (elapsed / this.totalDuration) * 100;
                
                document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
                
                if (this.isPlaying) {
                    requestAnimationFrame(() => this.updateProgress());
                }
            }

            async play(playString) {
                if (this.isPlaying) {
                    this.stop();
                }

                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.isPlaying = true;
                this.scheduledNodes = [];
                this.notesPlayed = 0;

                // Create analyser for visualizer
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;
                
                // Create gain node for master volume
                const masterGain = this.audioContext.createGain();
                masterGain.gain.value = this.masterVolume;
                masterGain.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);

                this.tempo = 120;
                this.octave = 4;
                this.defaultLength = 4;

                const commands = this.parsePlayString(playString);
                let currentTime = this.audioContext.currentTime;
                this.startTime = currentTime;

                for (const cmd of commands) {
                    if (!this.isPlaying) break;

                    switch (cmd.type) {
                        case 'TEMPO':
                            this.tempo = cmd.value;
                            this.updateStats();
                            break;
                        case 'OCTAVE':
                            this.octave = cmd.value;
                            this.updateStats();
                            break;
                        case 'LENGTH':
                            this.defaultLength = cmd.value;
                            this.updateStats();
                            break;
                        case 'PAUSE':
                            const pauseLength = cmd.length || this.defaultLength;
                            currentTime += this.getDuration(pauseLength);
                            break;
                        case 'CHORD':
                            const chordLength = cmd.length || this.defaultLength;
                            const chordDuration = this.getDuration(chordLength);
                            
                            for (const noteData of cmd.notes) {
                                const frequency = this.getFrequency(noteData.note, noteData.octave);
                                
                                if (frequency > 0) {
                                    const oscillator = this.audioContext.createOscillator();
                                    const gainNode = this.audioContext.createGain();
                                    
                                    oscillator.type = this.waveType;
                                    oscillator.frequency.value = frequency;
                                    
                                    const volume = 0.15 / Math.sqrt(cmd.notes.length);
                                    gainNode.gain.setValueAtTime(0, currentTime);
                                    gainNode.gain.linearRampToValueAtTime(volume, currentTime + 0.01);
                                    gainNode.gain.exponentialRampToValueAtTime(0.001, currentTime + chordDuration);
                                    
                                    oscillator.connect(gainNode);
                                    gainNode.connect(masterGain);
                                    
                                    oscillator.start(currentTime);
                                    oscillator.stop(currentTime + chordDuration);
                                    
                                    this.scheduledNodes.push({ oscillator, gainNode });
                                    this.notesPlayed++;
                                }
                            }
                            
                            currentTime += chordDuration;
                            break;
                        case 'NOTE':
                            const noteLength = cmd.length || this.defaultLength;
                            const duration = this.getDuration(noteLength);
                            const frequency = this.getFrequency(cmd.note, this.octave);
                            
                            if (frequency > 0) {
                                const oscillator = this.audioContext.createOscillator();
                                const gainNode = this.audioContext.createGain();
                                
                                oscillator.type = this.waveType;
                                oscillator.frequency.value = frequency;
                                
                                gainNode.gain.setValueAtTime(0, currentTime);
                                gainNode.gain.linearRampToValueAtTime(0.2, currentTime + 0.01);
                                gainNode.gain.exponentialRampToValueAtTime(0.001, currentTime + duration);
                                
                                oscillator.connect(gainNode);
                                gainNode.connect(masterGain);
                                
                                oscillator.start(currentTime);
                                oscillator.stop(currentTime + duration);
                                
                                this.scheduledNodes.push({ oscillator, gainNode });
                                this.notesPlayed++;
                            }
                            
                            currentTime += duration;
                            break;
                    }
                }

                this.totalDuration = currentTime - this.startTime;
                this.updateStats();
                this.startVisualizer();
                this.updateProgress();

                setTimeout(() => {
                    this.isPlaying = false;
                    this.visualizerRunning = false;
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('nowPlaying').textContent = 'Finished!';
                }, this.totalDuration * 1000);
            }

            stop() {
                this.isPlaying = false;
                this.visualizerRunning = false;
                
                this.scheduledNodes.forEach(({ oscillator, gainNode }) => {
                    try {
                        oscillator.stop();
                        oscillator.disconnect();
                        gainNode.disconnect();
                    } catch (e) {}
                });
                
                this.scheduledNodes = [];
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                document.getElementById('playBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('nowPlaying').textContent = 'Stopped';
            }
        }

        const player = new GWBasicChordPlayerV3();
        let selectedExample = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
            });
        });

        // Example selection
        document.querySelectorAll('.example').forEach(example => {
            example.addEventListener('click', () => {
                document.querySelectorAll('.example').forEach(e => e.classList.remove('selected'));
                example.classList.add('selected');
                selectedExample = example;
                
                const notation = example.getAttribute('data-notation');
                document.getElementById('playString').value = notation;
                document.getElementById('nowPlaying').textContent = example.querySelector('h4').textContent;
            });
        });

        // Play button
        document.getElementById('playBtn').addEventListener('click', () => {
            const playString = document.getElementById('playString').value;
            if (playString.trim()) {
                document.getElementById('playBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                player.play(playString);
            }
        });

        // Stop button
        document.getElementById('stopBtn').addEventListener('click', () => {
            player.stop();
        });

        // Clear button
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('playString').value = '';
            document.getElementById('nowPlaying').textContent = 'Ready...';
            document.querySelectorAll('.example').forEach(e => e.classList.remove('selected'));
        });

        // Copy button
        document.getElementById('copyBtn').addEventListener('click', () => {
            const textarea = document.getElementById('playString');
            textarea.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚úì COPIED!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        });

        // Save button
        document.getElementById('saveBtn').addEventListener('click', () => {
            const playString = document.getElementById('playString').value;
            const blob = new Blob([playString], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gwbasic-composition.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Load button
        document.getElementById('loadBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('playString').value = event.target.result;
                };
                reader.readAsText(file);
            };
            input.click();
        });

        // Wave type selector
        document.getElementById('waveType').addEventListener('change', (e) => {
            player.waveType = e.target.value;
        });

        // Volume slider
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('volumeValue').textContent = value;
            player.masterVolume = value / 100;
        });

        // Reverb slider
        document.getElementById('reverbSlider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('reverbValue').textContent = value;
            player.reverbAmount = value / 100;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('playBtn').click();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    if (player.isPlaying) {
                        document.getElementById('stopBtn').click();
                    } else {
                        document.getElementById('playBtn').click();
                    }
                }
            }
        });

        // Initial stats
        player.updateStats();
    </script>
</body>
</html>
